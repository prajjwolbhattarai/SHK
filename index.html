<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHK Rhein-Neckar | Branchenmagazin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      .writing-mode-vertical { writing-mode: vertical-rl; }
      .loader { border-top-color: #b45309; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      /* Custom typography overrides */
      .prose img { border-radius: 0.5rem; margin-top: 2em; margin-bottom: 2em; }
      .prose h2, .prose h3 { color: #0f172a; font-family: 'Montserrat', sans-serif; }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Montserrat', 'sans-serif'],
            },
            colors: {
              'brand-dark': '#0f172a',
              'brand-copper': '#b45309',
              'brand-steel': '#475569',
              'brand-surface': '#f8fafc',
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.8s ease-out forwards',
              'fade-in': 'fadeIn 1s ease-out forwards',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              }
            }
          }
        }
      }
    </script>
</head>
<body class="bg-brand-surface text-slate-900 antialiased selection:bg-brand-copper selection:text-white">
    <div id="progress-bar-container" class="fixed top-0 left-0 w-full h-1 z-[60] bg-transparent"></div>
    <div id="header-container"></div>
    <main id="main-content" class="min-h-screen">
        <!-- Static content is rendered first, then replaced by live data -->
    </main>
    <div id="footer-container"></div>

<script>
// V A N I L L A   J S   A P P L I C A T I O N

// --- 1. CONFIGURATION ---
// This URL allows public read access to the data synced by the CMS
const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx5H-kM0WL3NuIG4ZARhXI5K1jWCSat28nko2kH0vym3HT2K6uWGtRlLFQ8mHSGxCU1EQ/exec';

// --- 2. DATA STORE ---
// Skeleton Data for instant load while fetching
const SKELETON_ARTICLES = [{"id":"art-1","type":"article","title":"Laden der Inhalte...","summary":"Bitte warten Sie einen Moment, während wir die neuesten Artikel für Sie abrufen.","imageUrl":"https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&q=80&w=1200","category":"Branchen-News","author":"System","publishedAt":new Date().toISOString(),"featured":true}];
const SKELETON_DIRECTORY = [{"id":"dir-1","name":"Laden...","category":"Allgemein","address":"...","city":"...","zip":"...","phone":"...","website":"","description":"Verzeichnis wird geladen.","logoUrl":""}];

// Initial Data Load from Cache or Skeleton
let ALL_ARTICLES = SKELETON_ARTICLES;
let ALL_DIRECTORY = SKELETON_DIRECTORY;
try {
    const cachedArt = localStorage.getItem('shk_articles_cache');
    if(cachedArt) ALL_ARTICLES = JSON.parse(cachedArt);
    const cachedDir = localStorage.getItem('shk_directory_cache');
    if(cachedDir) ALL_DIRECTORY = JSON.parse(cachedDir);
} catch(e) {}

const INITIAL_CATEGORIES = ['Branchen-News', 'Betriebs-Features', 'Personal & Karriere', 'Technologie', 'Energie & Nachhaltigkeit', 'Regional'];

// --- 3. LANGUAGE MANAGER ---
const translations={en:{'nav.home':'Home','nav.directory':'Directory','hero.title':'The Leading SHK Industry Magazine.','hero.subtitle':"Trusted industry coverage, insights, and success stories for sanitary, heating, and climate professionals in the Rhein-Neckar region.",'hero.read_latest':'Read Latest','hero.submit_story':'Submit a Story','section.top_story':'Top Story','section.latest_news':'Latest Industry News','newsletter.title':'Stay Informed. No Spam.','newsletter.text':'Get the weekly digest of the most important SHK news in Rhein-Neckar.','newsletter.placeholder':'Your work email...','newsletter.button':'Subscribe','footer.about':'The independent voice for the Sanitary, Heating, and Climate industry in the metropolitan region.','article.read_story':'Read Story','article.watch_video':'Watch Video','search.placeholder':'Search articles...','search.no_results':'No articles found matching your search.','btn.show_more':'Show More','btn.load_more':'Load More Articles','nav.get_featured':'Get Featured','cat.Branchen-News':'Industry News','cat.Betriebs-Features':'Company Features','cat.Personal & Karriere':'HR & Careers','cat.Technologie':'Technology','cat.Energie & Nachhaltigkeit':'Energy & Sustainability','cat.Regional':'Regional','article.read_time':'min read','article.share':'Share','directory.title':'Business Directory','directory.subtitle':'Find qualified SHK professionals in the Rhein-Neckar region.','search.placeholder_dir':'Search by name or city...'},de:{'nav.home':'Startseite','nav.directory':'Verzeichnis','hero.title':'Das führende SHK-Branchenmagazin.','hero.subtitle':'Verlässliche Berichterstattung, Einblicke und Erfolgsgeschichten für Sanitär-, Heizungs- und Klimaprofis in der Metropolregion Rhein-Neckar.','hero.read_latest':'Aktuelles lesen','hero.submit_story':'Story einreichen','section.top_story':'Top Story','section.latest_news':'Neueste Branchennachrichten','newsletter.title':'Informiert bleiben. Kein Spam.','newsletter.text':'Erhalten Sie die wöchentliche Zusammenfassung der wichtigsten SHK-Nachrichten.','newsletter.placeholder':'Ihre geschäftliche E-Mail...','newsletter.button':'Abonnieren','footer.about':'Die unabhängige Stimme für die Sanitär-, Heizungs- und Klimabranche in der Metropolregion.','article.read_story':'Artikel lesen','article.watch_video':'Video ansehen','search.placeholder':'Artikel suchen...','search.no_results':'Keine Artikel gefunden.','btn.show_more':'Mehr Anzeigen','btn.load_more':'Weitere Artikel laden','nav.get_featured':'Artikel Einreichen','cat.Branchen-News':'Branchen-News','cat.Betriebs-Features':'Betriebs-Features','cat.Personal & Karriere':'Personal & Karriere','cat.Technologie':'Technologie','cat.Energie & Nachhaltigkeit':'Energie & Nachhaltigkeit','cat.Regional':'Regional','article.read_time':'Min Lesezeit','article.share':'Teilen','directory.title':'Branchenverzeichnis','directory.subtitle':'Finden Sie qualifizierte SHK-Fachbetriebe in der Rhein-Neckar-Region.','search.placeholder_dir':'Suche nach Name oder Stadt...'}};const languageManager={currentLanguage:'de',getLanguage:()=>{const t=localStorage.getItem('shk_lang')||'de';return languageManager.currentLanguage=t,t},setLanguage:t=>{languageManager.currentLanguage=t,localStorage.setItem('shk_lang',t),renderPage()},t:t=>translations[languageManager.currentLanguage]?.[t]||translations.de[t]||t};

// --- 4. TEMPLATES ---
const createHeaderHTML=(t,e,view)=>{const a=languageManager.t;return`
    <nav class="sticky top-0 z-50 transition-all duration-300 bg-white/95 backdrop-blur-md shadow-md border-b border-gray-200 py-0">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-20 items-center">
          <div class="flex items-center lg:hidden">
            <button id="mobile-menu-btn" class="p-2 text-brand-dark"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></button>
          </div>
          <div class="flex-shrink-0 flex items-center justify-center lg:justify-start w-full lg:w-auto cursor-pointer" onclick="window.location.href='index.html'">
            <img src="shklogo.jpg" alt="SHK Rhein-Neckar" class="w-auto object-contain h-12"/>
          </div>
          <div class="hidden lg:flex space-x-8 items-center h-full">
              <a href="index.html" class="nav-link relative h-full text-xs font-bold uppercase tracking-widest transition-colors flex items-center ${view!=='directory'&&e==='All'?"text-brand-copper":"text-brand-steel hover:text-brand-dark"}">
                ${a("nav.home")}
                ${view!=='directory'&&e==='All'?'<span class="absolute bottom-0 left-0 w-full h-0.5 bg-brand-copper"></span>':""}
              </a>
              <a href="?view=directory" class="nav-link relative h-full text-xs font-bold uppercase tracking-widest transition-colors flex items-center ${view==='directory'?"text-brand-copper":"text-brand-steel hover:text-brand-dark"}">
                ${a("nav.directory")}
                ${view==='directory'?'<span class="absolute bottom-0 left-0 w-full h-0.5 bg-brand-copper"></span>':""}
              </a>
              ${t.slice(0,4).map(t=>`
                <a href="index.html?category=${encodeURIComponent(t)}" class="nav-link relative h-full text-xs font-bold uppercase tracking-widest transition-colors flex items-center ${view!=='directory'&&e===t?"text-brand-copper":"text-brand-steel hover:text-brand-dark"}">
                  ${a(`cat.${t}`)}
                  ${view!=='directory'&&e===t?'<span class="absolute bottom-0 left-0 w-full h-0.5 bg-brand-copper"></span>':""}
                </a>
              `).join("")}
          </div>
          <div class="flex items-center space-x-4">
            <div id="search-container" class="flex items-center transition-all duration-300 w-8">
              <button id="search-toggle-btn" class="p-2 text-brand-steel hover:text-brand-copper transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>
              </button>
            </div>
            <div class="hidden lg:block relative group">
              <button id="lang-menu-btn" class="flex items-center space-x-2 text-xs font-bold uppercase text-brand-steel hover:text-brand-dark transition-colors">
                  <span>${languageManager.currentLanguage.toUpperCase()}</span>
              </button>
              <div id="lang-menu" class="absolute hidden right-0 mt-4 w-40 bg-white border border-gray-100 shadow-xl rounded-sm py-2 z-50">
                ${["de","en"].map(t=>`<button data-lang="${t}" class="lang-option-btn w-full text-left px-4 py-3 text-xs font-bold flex items-center hover:bg-gray-50 transition-colors ${languageManager.currentLanguage===t?"text-brand-copper bg-orange-50/50":"text-gray-700"}">${"de"===t?"Deutsch":"English"}</button>`).join("")}
              </div>
            </div>
            <a href="index.html?id=page-submit" class="hidden lg:block bg-brand-dark text-white px-6 py-3 text-xs font-bold uppercase tracking-wider rounded-sm hover:shadow-lg transition-all">${a("nav.get_featured")}</a>
          </div>
        </div>
      </div>
      <div id="mobile-menu" class="hidden lg:hidden border-t border-gray-100 bg-white absolute w-full z-50 shadow-2xl"></div>
    </nav>
    `};

const createFooterHTML=t=>{const e=languageManager.t;return`
    <footer class="bg-white border-t border-gray-200 pt-16 pb-8">
      <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-12">
        <div class="col-span-1 md:col-span-4 lg:col-span-2">
          <img src="shklogo.jpg" alt="SHK Rhein-Neckar" class="h-16 w-auto mb-4"/>
          <p class="text-sm text-brand-steel leading-relaxed max-w-sm">${e("footer.about")}</p>
        </div>
        <div class="lg:col-start-3">
          <h3 class="text-xs font-bold uppercase tracking-widest text-brand-dark mb-6">Magazin</h3>
          <ul class="space-y-3 text-sm text-brand-steel">
            <li><a href="index.html" class="hover:text-brand-copper transition">${e("nav.home")}</a></li>
            <li><a href="?view=directory" class="hover:text-brand-copper transition">${e("nav.directory")}</a></li>
            ${t.slice(0,4).map(t=>`<li><a href="index.html?category=${encodeURIComponent(t)}" class="hover:text-brand-copper transition">${e(`cat.${t}`)}</a></li>`).join("")}
          </ul>
        </div>
        <div>
          <h3 class="text-xs font-bold uppercase tracking-widest text-brand-dark mb-6">Kontakt</h3>
          <ul class="space-y-3 text-sm text-brand-steel">
            <li class="flex items-start">redaktion@shk-rhein-neckar.de</li>
            <li class="flex items-start">Mannheim, Germany</li>
          </ul>
        </div>
      </div>
      <div class="max-w-7xl mx-auto px-4 mt-16 pt-8 border-t border-gray-100 flex justify-between items-center text-xs text-gray-400">
        <span>© 2025 SHK Rhein-Neckar.</span>
        <a href="admin.html" class="text-gray-300 hover:text-brand-copper transition">Login</a>
      </div>
    </footer>
    `};

const createArticleCardHTML=(t,e="standard")=>{const a=languageManager.t,r=t.title,n=t.summary;return"featured"===e?`
        <a href="index.html?id=${t.id}" class="group relative block w-full h-[600px] overflow-hidden rounded-sm shadow-2xl cursor-pointer">
            <img src="${t.imageUrl}" alt="${r}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105"/>
            <div class="absolute inset-0 bg-gradient-to-t from-brand-dark via-brand-dark/70 to-transparent opacity-90 transition-opacity duration-500 group-hover:opacity-100"></div>
            <div class="absolute bottom-0 left-0 p-8 md:p-12 text-white max-w-5xl z-20">
                <div class="overflow-hidden mb-6"><span class="inline-block uppercase tracking-[0.2em] text-[10px] font-bold bg-brand-copper text-white px-3 py-1.5 rounded-sm transform translate-y-0 transition-transform group-hover:-translate-y-1">${t.category}</span></div>
                <h2 class="text-3xl md:text-5xl lg:text-6xl font-display font-black mb-6 leading-none tracking-tight group-hover:text-gray-100 transition-colors">${r}</h2>
                <p class="text-gray-300 mb-8 line-clamp-2 max-w-2xl font-light text-lg md:text-xl leading-relaxed opacity-90 group-hover:opacity-100 transition-opacity">${n}</p>
                <div class="flex items-center space-x-6 text-xs font-bold text-gray-400 uppercase tracking-widest border-t border-white/10 pt-6">
                    <span class="text-brand-copper">${t.author}</span>
                    <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                    <span class="flex items-center">${new Date(t.publishedAt).toLocaleDateString()}</span>
                </div>
            </div>
        </a>`:`
    <a href="index.html?id=${t.id}" class="flex flex-col group cursor-pointer h-full bg-white rounded-sm overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-2 border border-transparent hover:border-gray-100">
      <div class="overflow-hidden aspect-[16/10] relative">
        <img src="${t.imageUrl}" alt="${r}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"/>
        <div class="absolute top-4 left-4"><span class="bg-white/90 backdrop-blur-sm text-brand-dark text-[10px] font-bold uppercase tracking-widest px-3 py-1.5 shadow-sm rounded-sm">${t.category}</span></div>
      </div>
      <div class="flex flex-col flex-grow p-6 relative">
        <div class="mb-4 flex items-center text-[10px] font-bold text-gray-400 uppercase tracking-wider space-x-2">
           <span>${new Date(t.publishedAt).toLocaleDateString()}</span>
        </div>
        <h3 class="text-xl font-display font-bold text-brand-dark mb-3 leading-snug group-hover:text-brand-copper transition-colors">${r}</h3>
        <p class="text-brand-steel text-sm line-clamp-3 mb-6 flex-grow leading-relaxed">${n}</p>
        <div class="mt-auto pt-4 border-t border-gray-50 flex items-center text-xs font-bold uppercase tracking-wider text-brand-dark group-hover:text-brand-copper transition-colors">
           ${a("article.read_story")} 
        </div>
      </div>
    </a>`};

const createDirectoryCardHTML=e=>{const t={Heizung:"bg-red-100 text-red-800 border-red-200",Sanitär:"bg-blue-100 text-blue-800 border-blue-200",Klima:"bg-sky-100 text-sky-800 border-sky-200",Lüftung:"bg-green-100 text-green-800 border-green-200",Elektro:"bg-yellow-100 text-yellow-800 border-yellow-200"};return`
    <div class="bg-white rounded-sm border border-gray-100 p-6 flex flex-col h-full hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
        <div class="flex items-start mb-4">
            <img src="${e.logoUrl}" alt="${e.name} logo" class="w-16 h-16 rounded-sm object-contain border border-gray-100 p-1 mr-4 bg-white" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';">
            <div class="flex-grow">
                <h3 class="font-display font-bold text-lg text-brand-dark leading-tight">${e.name}</h3>
                <span class="mt-1 inline-block text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-sm border ${t[e.category]||"bg-gray-100 text-gray-800"}">${e.category}</span>
            </div>
        </div>
        <p class="text-sm text-brand-steel mb-5 leading-relaxed flex-grow">${e.description}</p>
        <div class="mt-auto space-y-3 text-sm text-brand-steel border-t border-gray-100 pt-5">
            <div class="flex items-start"><span>${e.address}, ${e.zip} ${e.city}</span></div>
            <div class="flex items-center"><span>${e.phone}</span></div>
            ${e.website?`<div class="flex items-center"><a href="${e.website}" target="_blank" rel="noopener noreferrer" class="text-brand-copper hover:underline truncate">${e.website.replace(/^(https?:\/\/)?(www\.)?/,"")}</a></div>`:""}
        </div>
    </div>`};

// --- 5. PAGE-SPECIFIC LOGIC ---
const appState = {
    view: 'magazine', 
    activeCategory: 'All',
    searchQuery: '',
    displayedCount: 100, 
    articlesLoading: false,
    directoryLoading: false,
};

function renderMagazinePage(isUpdate = false) {
    if (isUpdate && document.getElementById('article-grid-container')) {
        document.getElementById('article-grid-container').innerHTML = renderArticleGridHTML();
        attachMagazineEventListeners();
        return;
    }
    document.getElementById('progress-bar-container').innerHTML = '';
    const t = languageManager.t;
    const mainContent = document.getElementById('main-content');
    
    mainContent.innerHTML = `
        <div class="relative w-full h-[650px] flex items-center bg-brand-dark overflow-hidden group">
            <div class="absolute inset-0 z-0">
               <img src="https://images.unsplash.com/photo-1581092334651-ddf26d9a09d0?auto=format&fit=crop&q=80&w=2000" class="w-full h-full object-cover opacity-60" alt="Industrial Background" />
               <div class="absolute inset-0 bg-gradient-to-r from-brand-dark via-brand-dark/90 to-transparent"></div>
            </div>
            <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
              <div class="max-w-3xl space-y-8 animate-fade-in-up">
                 <h1 class="text-5xl md:text-7xl lg:text-8xl font-display font-black text-white leading-[0.9] tracking-tighter">${t('hero.title')}</h1>
                 <p class="text-xl md:text-2xl text-gray-300 font-light leading-relaxed max-w-xl border-l-4 border-white/10 pl-6">${t('hero.subtitle')}</p>
                 <div class="flex flex-wrap gap-4 pt-8">
                    <button onclick="document.getElementById('article-grid-container')?.scrollIntoView({ behavior: 'smooth'})" class="bg-brand-copper text-white px-10 py-4 text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-brand-dark transition-all duration-300 rounded-sm shadow-xl">${t('hero.read_latest')}</button>
                 </div>
              </div>
            </div>
        </div>
        <div id="article-grid-container">
            ${renderArticleGridHTML()}
        </div>
        <section class="py-24 px-4 bg-brand-surface">
            <div class="max-w-6xl mx-auto bg-brand-dark rounded-sm overflow-hidden shadow-2xl relative">
                <div class="relative z-10 grid md:grid-cols-2 gap-12 p-12 md:p-20 items-center">
                    <div class="text-left space-y-6">
                       <h2 class="text-4xl font-display font-bold text-white leading-tight">${t('newsletter.title')}</h2>
                       <p class="text-gray-400 text-lg leading-relaxed">${t('newsletter.text')}</p>
                    </div>
                    <div class="bg-white/5 backdrop-blur-sm p-8 rounded-sm border border-white/10">
                       <form class="flex flex-col gap-4" onsubmit="event.preventDefault();">
                         <input type="email" placeholder="${t('newsletter.placeholder')}" class="w-full px-6 py-4 bg-white/10 border border-white/10 rounded-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-copper" />
                         <button class="w-full bg-brand-copper text-white px-6 py-4 font-bold uppercase tracking-widest text-xs hover:bg-white hover:text-brand-dark transition-all rounded-sm mt-2">${t('newsletter.button')}</button>
                       </form>
                    </div>
                </div>
            </div>
        </section>
    `;
    attachMagazineEventListeners();
}

function renderArticleGridHTML() {
    const t = languageManager.t;
    let displayArticles = ALL_ARTICLES.filter(a => a.type !== 'page' && a.status !== 'draft');

    if (appState.searchQuery) {
        const lowerQuery = appState.searchQuery.toLowerCase();
        displayArticles = displayArticles.filter(a => a.title.toLowerCase().includes(lowerQuery) || a.summary.toLowerCase().includes(lowerQuery));
    } else if (appState.activeCategory !== 'All') {
        displayArticles = displayArticles.filter(a => a.category === appState.activeCategory);
    }
    
    const featuredArticle = !appState.searchQuery && appState.activeCategory === 'All' ? displayArticles.find(a => a.featured) : null;
    let gridArticles = featuredArticle ? displayArticles.filter(a => a.id !== featuredArticle.id) : displayArticles;

    let gridContent = `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-24">`;
    if (featuredArticle) {
      gridContent += `<section class="mb-24"><div class="flex items-center space-x-6 mb-10"><div class="h-px bg-gray-200 flex-grow"></div><span class="text-brand-steel uppercase tracking-[0.2em] text-xs font-bold">${t('section.top_story')}</span><div class="h-px bg-gray-200 flex-grow"></div></div>${createArticleCardHTML(featuredArticle, 'featured')}</section>`;
    }

    gridContent += `
    <section>
        <div class="flex items-end justify-between mb-12 border-b border-gray-200 pb-6">
            <h2 class="text-3xl font-display font-bold text-brand-dark flex items-center">
                <span>${appState.activeCategory === 'All' ? t('section.latest_news') : (t(`cat.${appState.activeCategory}`) || appState.activeCategory)}</span>
                <div id="loading-indicator" class="ml-4 ${appState.articlesLoading ? '' : 'hidden'}"><div class="w-5 h-5 border-2 border-gray-300 rounded-full loader"></div></div>
            </h2>
            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest hidden sm:block">${gridArticles.length} Stories</span>
        </div>
        <div id="article-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-16">
            ${gridArticles.slice(0, appState.displayedCount).map((article) => `<div key="${article.id}">${createArticleCardHTML(article)}</div>`).join('')}
        </div>
    </section>
    </div>`;

    return gridContent;
}

function renderArticleReader(articleId) {
    const e=ALL_ARTICLES.find(t=>t.id===articleId);if(!e)return void(document.getElementById("main-content").innerHTML='<div class="text-center py-40"><h1 class="text-2xl font-bold">Artikel nicht gefunden</h1><a href="index.html" class="text-brand-copper mt-4 inline-block">Zurück zur Startseite</a></div>');
    document.title=`${e.title} | SHK Rhein-Neckar`;
    document.getElementById("progress-bar-container").innerHTML='<div id="progress-bar" class="h-full bg-brand-copper transition-all duration-100 ease-out shadow-[0_0_10px_#b45309]" style="width: 0%"></div>';
    
    // Renders the full article content including HTML formatting from Google Doc
    document.getElementById("main-content").innerHTML=`
    <article class="max-w-6xl mx-auto my-0 bg-white min-h-screen">
        <header class="px-4 py-16 md:py-24 text-center max-w-4xl mx-auto">
           <div class="mb-8"><a href="index.html?category=${encodeURIComponent(e.category)}" class="inline-block px-4 py-1.5 text-xs font-bold uppercase tracking-[0.2em] text-white bg-brand-dark rounded-sm hover:bg-brand-copper transition">${e.category}</a></div>
           <h1 class="text-4xl md:text-6xl font-display font-black text-brand-dark leading-[1.1] mb-10 tracking-tight">${e.title}</h1>
             <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-8 text-sm text-brand-steel border-t border-b border-gray-100 py-6">
               <div class="flex items-center"><span class="font-bold text-brand-dark uppercase tracking-wide text-xs">${e.author}</span></div>
               <div class="hidden md:block w-px h-4 bg-gray-300"></div>
               <div class="flex items-center"><span class="uppercase tracking-wide text-xs">${new Date(e.publishedAt).toLocaleDateString()}</span></div>
             </div>
        </header>

        ${e.imageUrl?`
        <div class="w-full aspect-video md:aspect-[21/9] overflow-hidden bg-gray-100 shadow-sm">
            <img src="${e.imageUrl}" alt="${e.title}" class="w-full h-full object-cover" />
        </div>`:""}

        <div class="px-4 py-16 grid grid-cols-1 lg:grid-cols-12 gap-12 max-w-7xl mx-auto">
           <div class="col-span-1 lg:col-span-8 lg:col-start-3">
             <!-- The prose class ensures proper formatting of HTML content from Google Doc -->
             <div class="prose prose-lg md:prose-xl prose-slate max-w-none text-gray-700 leading-loose prose-headings:font-display prose-headings:font-bold prose-headings:text-brand-dark">
               ${e.content || e.summary}
             </div>
           </div>
        </div>
    </article>`;
    
    window.addEventListener("scroll", ()=>{
        const t=document.documentElement.scrollTop,e=document.documentElement.scrollHeight-document.documentElement.clientHeight,a=t/e,r=document.getElementById("progress-bar");r&&(r.style.width=`${a*100}%`)
    });
}

function renderDirectoryPage(isUpdate = false) {
    if (isUpdate) {
        renderDirectoryGrid();
        return;
    }
    const t = languageManager.t;
    document.getElementById("progress-bar-container").innerHTML = '';
    
    document.getElementById('main-content').innerHTML = `
        <div class="bg-white py-16 md:py-24 border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl md:text-6xl font-display font-black text-brand-dark mb-4">${t('directory.title')}</h1>
                <p class="text-lg md:text-xl text-brand-steel max-w-2xl mx-auto">${t('directory.subtitle')}</p>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div class="sticky top-20 z-40 bg-brand-surface/80 backdrop-blur-md p-4 mb-12 rounded-sm border border-gray-200 flex flex-col md:flex-row gap-4 items-center">
                <div class="relative w-full md:w-1/2 lg:w-1/3">
                    <input type="text" id="dir-search-input" placeholder="${t('search.placeholder_dir')}" class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-sm focus:ring-2 focus:ring-brand-copper outline-none transition" />
                </div>
                <div id="category-filters" class="flex flex-wrap gap-2 justify-center">
                    <button data-category="All" class="filter-btn px-4 py-2 text-xs font-bold uppercase tracking-wider rounded-full transition bg-brand-dark text-white">Alle</button>
                    ${['Heizung', 'Sanitär', 'Klima', 'Lüftung', 'Elektro'].map(cat => `<button data-category="${cat}" class="filter-btn px-4 py-2 text-xs font-bold uppercase tracking-wider rounded-full transition bg-white text-brand-dark hover:bg-gray-100 border border-gray-200">${cat}</button>`).join('')}
                </div>
                <div id="loading-indicator" class="ml-4 ${appState.directoryLoading ? '' : 'hidden'}"><div class="w-5 h-5 border-2 border-gray-300 rounded-full loader"></div></div>
            </div>
            <div id="directory-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
        </div>`;
    
    renderDirectoryGrid();
    
    document.getElementById('dir-search-input')?.addEventListener('input', (e) => {
        appState.searchQuery = e.target.value;
        renderDirectoryGrid();
    });

    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            appState.activeCategory = e.target.getAttribute('data-category');
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-brand-dark', 'text-white');
                btn.classList.add('bg-white', 'text-brand-dark', 'hover:bg-gray-100', 'border', 'border-gray-200');
            });
            e.target.classList.add('bg-brand-dark', 'text-white');
            e.target.classList.remove('bg-white', 'text-brand-dark', 'hover:bg-gray-100', 'border', 'border-gray-200');
            renderDirectoryGrid();
        });
    });
}

function renderDirectoryGrid() {
    const grid = document.getElementById('directory-grid');
    if (!grid) return;
    
    const filteredBusinesses = ALL_DIRECTORY.filter(business => {
      const matchesCategory = appState.activeCategory === 'All' || business.category === appState.activeCategory;
      const matchesSearch = appState.searchQuery.length === 0 ||
        business.name.toLowerCase().includes(appState.searchQuery.toLowerCase()) ||
        business.city.toLowerCase().includes(appState.searchQuery.toLowerCase());
      return matchesCategory && matchesSearch;
    });

    if (filteredBusinesses.length > 0) {
        grid.innerHTML = filteredBusinesses.map(createDirectoryCardHTML).join('');
    } else {
        grid.innerHTML = `<div class="md:col-span-2 lg:col-span-3 xl:col-span-4 text-center py-32 bg-white rounded-sm border border-dashed border-gray-300"><p class="text-brand-steel font-medium text-lg">Keine Betriebe gefunden.</p></div>`;
    }
}

// --- 6. API FETCHERS (SMART SYNC) ---
async function startLiveSync() {
    // 1. Check local settings (for admin preview)
    let settings = {};
    try { settings = JSON.parse(localStorage.getItem('shk_settings')) || {}; } catch(e) {}
    
    // 2. Fallback to DEFAULT_SCRIPT_URL (Public User)
    const articleUrl = (settings.articlesScriptUrl || DEFAULT_SCRIPT_URL).trim();
    const directoryUrl = (settings.directoryScriptUrl || DEFAULT_SCRIPT_URL).trim();
    
    console.log("Starting Live Sync from:", articleUrl);
    appState.articlesLoading = true;
    appState.directoryLoading = true;
    updateLoaders();

    // OPTIMIZATION: If URLs are identical, fetch once
    if (articleUrl === directoryUrl) {
        try {
            const data = await fetchJson(articleUrl);
            if (data.articles) updateArticles(data.articles);
            if (data.directory) updateDirectory(data.directory);
        } catch (e) {
            console.warn("Unified sync failed, retrying separately...", e);
        }
    } else {
        // Parallel Fetch
        Promise.allSettled([
            fetchJson(articleUrl).then(d => d.articles && updateArticles(d.articles)),
            fetchJson(directoryUrl).then(d => d.directory && updateDirectory(d.directory))
        ]);
    }
}

async function fetchJson(url) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), 15000);
    try {
        const res = await fetch(url, { signal: controller.signal, redirect: 'follow' });
        clearTimeout(id);
        if(!res.ok) throw new Error(res.status);
        return await res.json();
    } catch (e) {
        clearTimeout(id);
        throw e;
    }
}

function updateArticles(newArticles) {
    if(!Array.isArray(newArticles)) return;
    ALL_ARTICLES = newArticles;
    // Cache for next visit
    localStorage.setItem('shk_articles_cache', JSON.stringify(ALL_ARTICLES));
    appState.articlesLoading = false;
    updateLoaders();
    if (appState.view === 'magazine') renderMagazinePage(true);
}

function updateDirectory(newDirectory) {
    if(!Array.isArray(newDirectory)) return;
    ALL_DIRECTORY = newDirectory;
    localStorage.setItem('shk_directory_cache', JSON.stringify(ALL_DIRECTORY));
    appState.directoryLoading = false;
    updateLoaders();
    if (appState.view === 'directory') renderDirectoryPage(true);
}

function updateLoaders() {
    const loader = document.getElementById('loading-indicator');
    if(loader) {
        if(appState.articlesLoading || appState.directoryLoading) loader.classList.remove('hidden');
        else loader.classList.add('hidden');
    }
}

// --- MAIN ROUTER ---
function renderPage() {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const view = urlParams.get('view');
    const category = urlParams.get('category');
    
    appState.view = view || (id ? 'article' : 'magazine');
    languageManager.getLanguage();

    appState.searchQuery = '';
    
    if (category) appState.activeCategory = category;
    else if(appState.view !== 'directory') appState.activeCategory = 'All'; 
    
    document.getElementById('header-container').innerHTML = createHeaderHTML(INITIAL_CATEGORIES, appState.activeCategory, appState.view);
    document.getElementById('footer-container').innerHTML = createFooterHTML(INITIAL_CATEGORIES);
    
    if (appState.view === 'directory') renderDirectoryPage();
    else if (id) renderArticleReader(id);
    else renderMagazinePage();
    
    attachGlobalEventListeners();
}

function attachMagazineEventListeners() {
    const t=document.getElementById("load-more-btn");t&&t.addEventListener("click",()=>{appState.displayedCount+="All"===appState.activeCategory?6:9,renderMagazinePage(!0)});
}

function attachGlobalEventListeners() {
    document.querySelectorAll(".lang-option-btn").forEach(t=>{t.addEventListener("click",()=>languageManager.setLanguage(t.getAttribute("data-lang")))});
    const t=document.getElementById("lang-menu-btn");t&&t.addEventListener("click",()=>{document.getElementById("lang-menu").classList.toggle("hidden")});
    const e=document.getElementById("mobile-menu-btn");
    e&&e.addEventListener("click",()=>{
        const t=document.getElementById("mobile-menu");
        if(t.classList.contains("hidden")){
             t.innerHTML=`
                <div class="px-6 py-6 space-y-4">
                    <a href="index.html" class="block w-full text-left py-3 text-sm font-bold uppercase tracking-wide text-brand-dark hover:text-brand-copper">Home</a>
                    <a href="?view=directory" class="block w-full text-left py-3 text-sm font-bold uppercase tracking-wide text-brand-dark hover:text-brand-copper">Directory</a>
                    ${INITIAL_CATEGORIES.map(t=>`<a href="index.html?category=${encodeURIComponent(t)}" class="block w-full text-left py-3 text-sm font-bold uppercase tracking-wide text-brand-dark hover:text-brand-copper">${languageManager.t(`cat.${t}`)}</a>`).join("")}
                </div>`;
             t.classList.remove("hidden");
        } else {
             t.classList.add("hidden");
        }
    });

    const a=document.getElementById("search-container"),r=document.getElementById("search-toggle-btn");
    r&&r.addEventListener("click",()=>{
        a.classList.remove("w-8"),a.classList.add("w-full","md:w-96"),a.innerHTML=`
            <form id="search-form" class="relative w-full flex items-center">
                <input type="text" id="search-input" placeholder="${languageManager.t("search.placeholder")}" class="w-full bg-gray-100 border-none rounded-sm px-4 py-2 pr-10 text-sm focus:ring-2 focus:ring-brand-copper outline-none" />
                <button type="button" id="search-close-btn" class="absolute right-2 p-1 text-gray-400 hover:text-brand-dark"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg></button>
            </form>`;
        document.getElementById("search-input").focus();
        document.getElementById("search-form").addEventListener("submit",t=>{t.preventDefault();appState.searchQuery=document.getElementById("search-input").value;appState.displayedCount=100;renderMagazinePage(!0)});
        document.getElementById("search-close-btn").addEventListener("click",()=>{appState.searchQuery="";renderMagazinePage(!0)});
    });
}

document.addEventListener('DOMContentLoaded', () => {
    renderPage();
    // 1. Immediate Sync on Load
    startLiveSync();
    
    // 2. Scheduled Sync (every 30 mins)
    setInterval(startLiveSync, 30 * 60 * 1000);
    
    // 3. Listen for CMS updates from other tabs
    window.addEventListener('storage', (e) => {
        if(e.key === 'shk_articles') { ALL_ARTICLES = JSON.parse(e.newValue); if(appState.view === 'magazine') renderMagazinePage(true); }
        if(e.key === 'shk_directory') { ALL_DIRECTORY = JSON.parse(e.newValue); if(appState.view === 'directory') renderDirectoryPage(true); }
    });
});
</script>
</body>
</html>