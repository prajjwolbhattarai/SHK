<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHK Rhein-Neckar | Branchenmagazin & Verzeichnis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      .writing-mode-vertical { writing-mode: vertical-rl; }
      .loader { border-top-color: #b45309; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .fade-enter { opacity: 0; }
      .fade-enter-active { opacity: 1; transition: opacity 300ms ease-in; }
      .fade-exit { opacity: 1; }
      .fade-exit-active { opacity: 0; transition: opacity 300ms ease-out; }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Montserrat', 'sans-serif'],
            },
            colors: {
              'brand-dark': '#0f172a',
              'brand-copper': '#b45309',
              'brand-steel': '#475569',
              'brand-surface': '#f8fafc',
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.8s ease-out forwards',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
</head>
<body class="bg-brand-surface text-slate-900 antialiased selection:bg-brand-copper selection:text-white">
    <div id="progress-bar-container" class="fixed top-0 left-0 w-full h-1 z-[60] bg-transparent"></div>
    <div id="header-container"></div>
    <main id="main-content" class="min-h-screen">
        <!-- Content injected by JS -->
    </main>
    <div id="footer-container"></div>

<script>
// --- DATA STORE (SKELETON) ---
let DATA = {
    articles: [
        {id:"art-1",type:"article",title:"Neue Energieverordnungen 2025: Was gilt ab Januar?",summary:"Ein umfassender Bericht über Neue Energieverordnungen 2025.",imageUrl:"https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Redaktion",publishedAt:"2025-10-25T10:00:00.000Z",featured:true},
        {id:"art-2",type:"article",title:"Rückblick ISH Messe Frankfurt: Die Highlights",summary:"Die wichtigsten Trends der Weltleitmesse für Wasser, Wärme, Luft.",imageUrl:"https://images.unsplash.com/photo-1542744173-8e7e53415bb0?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Markus Weber",publishedAt:"2025-10-24T10:00:00.000Z",featured:false},
        {id:"art-3",type:"article",title:"Großhandelspreise stabilisieren sich",summary:"Entwarnung für Handwerksbetriebe: Materialpreise pendeln sich ein.",imageUrl:"https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Julia Schmidt",publishedAt:"2025-10-23T10:00:00.000Z",featured:false}
    ],
    directory: [
        {id:"dir-1",name:"Heizungstechnik Müller GmbH",category:"Heizung",address:"Hauptstraße 10",city:"Mannheim",zip:"68159",phone":"0621 123456",website:"https://heizung-mueller.de",description:"Spezialist für moderne Heizsysteme und Wärmepumpen.",logoUrl:"https://logo.clearbit.com/heizung-mueller.de"},
        {id:"dir-2",name:"Sanitär-Service Weber",category":"Sanitär",address:"Bergheimer Straße 58",city:"Heidelberg",zip:"69115",phone":"06221 654321",website:"https://sanitaer-weber.de",description:"Komplettbäder aus einer Hand. Barrierefreie Umbauten.",logoUrl:"https://logo.clearbit.com/sanitaer-weber.de"}
    ],
    categories: ['Branchen-News', 'Betriebs-Features', 'Personal & Karriere', 'Technologie', 'Energie & Nachhaltigkeit', 'Regional']
};

const appState = {
    view: 'magazine', // magazine, article, directory
    activeCategory: 'All',
    searchQuery: '',
    loading: false
};

// --- LANGUAGE ---
const translations={en:{'nav.home':'Home','nav.directory':'Directory','hero.title':'The Leading SHK Industry Magazine.','hero.subtitle':"Trusted industry coverage, insights, and success stories for sanitary, heating, and climate professionals in the Rhein-Neckar region.",'hero.read_latest':'Read Latest','hero.submit_story':'Submit a Story','section.top_story':'Top Story','section.latest_news':'Latest Industry News','newsletter.title':'Stay Informed. No Spam.','newsletter.button':'Subscribe','footer.about':'The independent voice for the Sanitary, Heating, and Climate industry.','article.read_story':'Read Story','btn.load_more':'Load More Articles','directory.title':'Business Directory','directory.subtitle':'Find qualified SHK professionals in the Rhein-Neckar region.','search.placeholder_dir':'Search by name or city...'},de:{'nav.home':'Startseite','nav.directory':'Verzeichnis','hero.title':'Das führende SHK-Branchenmagazin.','hero.subtitle':'Verlässliche Berichterstattung, Einblicke und Erfolgsgeschichten für Sanitär-, Heizungs- und Klimaprofis in der Metropolregion Rhein-Neckar.','hero.read_latest':'Aktuelles lesen','hero.submit_story':'Story einreichen','section.top_story':'Top Story','section.latest_news':'Neueste Branchennachrichten','newsletter.title':'Informiert bleiben. Kein Spam.','newsletter.button':'Abonnieren','footer.about':'Die unabhängige Stimme für die Sanitär-, Heizungs- und Klimabranche.','article.read_story':'Artikel lesen','btn.load_more':'Weitere Artikel laden','directory.title':'Branchenverzeichnis','directory.subtitle':'Finden Sie qualifizierte SHK-Fachbetriebe in der Rhein-Neckar-Region.','search.placeholder_dir':'Suche nach Name oder Stadt...'}};
const languageManager={currentLanguage:'de',t:e=>translations[languageManager.currentLanguage]?.[e]||translations.de[e]||e};

// --- RENDERERS ---

function createHeaderHTML(activeView, activeCategory) {
    const t = languageManager.t;
    return `
    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-md border-b border-gray-200 py-0">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-20 items-center">
          <a href="?view=magazine" class="flex-shrink-0 flex items-center cursor-pointer">
            <img src="shklogo.jpg" alt="SHK Rhein-Neckar" class="w-auto object-contain h-12"/>
          </a>
          <!-- Desktop Nav -->
          <div class="hidden lg:flex space-x-8 items-center h-full">
              <a href="?view=magazine" class="relative h-full text-xs font-bold uppercase tracking-widest transition-colors flex items-center ${activeView === 'magazine' && activeCategory === 'All' ? 'text-brand-copper border-b-2 border-brand-copper' : 'text-brand-steel hover:text-brand-dark'}">${t("nav.home")}</a>
              <a href="?view=directory" class="relative h-full text-xs font-bold uppercase tracking-widest transition-colors flex items-center ${activeView === 'directory' ? 'text-brand-copper border-b-2 border-brand-copper' : 'text-brand-steel hover:text-brand-dark'}">${t("nav.directory")}</a>
              ${DATA.categories.slice(0, 4).map(c => `
                <a href="?view=magazine&category=${encodeURIComponent(c)}" class="relative h-full text-xs font-bold uppercase tracking-widest transition-colors flex items-center ${activeCategory === c ? 'text-brand-copper border-b-2 border-brand-copper' : 'text-brand-steel hover:text-brand-dark'}">
                  ${c}
                </a>
              `).join("")}
          </div>
          <!-- Right Actions -->
          <div class="flex items-center space-x-4">
            <div id="loading-indicator" class="hidden"><div class="w-4 h-4 border-2 border-brand-copper rounded-full loader"></div></div>
            <a href="?view=article&id=page-submit" class="hidden lg:block bg-brand-dark text-white px-6 py-3 text-xs font-bold uppercase tracking-wider rounded-sm hover:bg-brand-copper transition">${t("hero.submit_story")}</a>
          </div>
        </div>
      </div>
    </nav>`;
}

function createFooterHTML() {
    const t = languageManager.t;
    return `
    <footer class="bg-white border-t border-gray-200 pt-16 pb-8 mt-auto">
      <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-12">
        <div class="col-span-1 md:col-span-2">
          <img src="shklogo.jpg" alt="SHK Rhein-Neckar" class="h-16 w-auto mb-4"/>
          <p class="text-sm text-brand-steel leading-relaxed max-w-sm">${t("footer.about")}</p>
        </div>
        <div>
          <h3 class="text-xs font-bold uppercase tracking-widest text-brand-dark mb-6">Magazin</h3>
          <ul class="space-y-3 text-sm text-brand-steel">
            <li><a href="?view=magazine" class="hover:text-brand-copper">Startseite</a></li>
            <li><a href="?view=directory" class="hover:text-brand-copper">Verzeichnis</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xs font-bold uppercase tracking-widest text-brand-dark mb-6">Kontakt</h3>
          <ul class="space-y-3 text-sm text-brand-steel">
            <li>redaktion@shk-rhein-neckar.de</li>
            <li>Mannheim, Germany</li>
          </ul>
        </div>
      </div>
      <div class="max-w-7xl mx-auto px-4 mt-16 pt-8 border-t border-gray-100 text-center text-xs text-gray-400">
          <span>© 2025 SHK Rhein-Neckar. Alle Rechte vorbehalten.</span>
          <a href="admin.html" class="ml-4 text-gray-300 hover:text-brand-copper transition">Login</a>
      </div>
    </footer>`;
}

// --- VIEW: MAGAZINE ---
function renderMagazine() {
    const t = languageManager.t;
    let articles = DATA.articles.filter(a => a.type !== 'page' && a.status !== 'draft');
    
    if (appState.activeCategory !== 'All') {
        articles = articles.filter(a => a.category === appState.activeCategory);
    }
    
    const featured = articles.find(a => a.featured);
    const gridArticles = featured ? articles.filter(a => a.id !== featured.id) : articles;

    const heroHTML = `
    <div class="relative w-full h-[500px] flex items-center bg-brand-dark overflow-hidden group">
        <div class="absolute inset-0 z-0">
           <img src="https://images.unsplash.com/photo-1581092334651-ddf26d9a09d0?auto=format&fit=crop&q=80&w=2000" class="w-full h-full object-cover opacity-60" />
           <div class="absolute inset-0 bg-gradient-to-r from-brand-dark via-brand-dark/90 to-transparent"></div>
        </div>
        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full animate-fade-in-up">
             <h1 class="text-4xl md:text-6xl lg:text-7xl font-display font-black text-white mb-6 leading-tight">${t('hero.title')}</h1>
             <p class="text-lg md:text-xl text-gray-300 font-light max-w-xl border-l-4 border-white/10 pl-6">${t('hero.subtitle')}</p>
        </div>
    </div>`;

    const featuredHTML = featured ? `
    <section class="mb-24">
        <div class="flex items-center space-x-6 mb-10"><div class="h-px bg-gray-200 flex-grow"></div><span class="text-brand-steel uppercase tracking-[0.2em] text-xs font-bold">${t('section.top_story')}</span><div class="h-px bg-gray-200 flex-grow"></div></div>
        <a href="?view=article&id=${featured.id}" class="group relative block w-full h-[600px] overflow-hidden rounded-sm shadow-2xl cursor-pointer">
            <img src="${featured.imageUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105"/>
            <div class="absolute inset-0 bg-gradient-to-t from-brand-dark via-brand-dark/70 to-transparent opacity-90 transition-opacity duration-500 group-hover:opacity-100"></div>
            <div class="absolute bottom-0 left-0 p-8 md:p-12 text-white max-w-5xl z-20">
                <span class="inline-block uppercase tracking-[0.2em] text-[10px] font-bold bg-brand-copper text-white px-3 py-1.5 rounded-sm mb-6">${featured.category}</span>
                <h2 class="text-3xl md:text-5xl lg:text-6xl font-display font-black mb-6 leading-none group-hover:text-gray-100">${featured.title}</h2>
                <p class="text-gray-300 mb-8 line-clamp-2 max-w-2xl font-light text-lg md:text-xl">${featured.summary}</p>
            </div>
        </a>
    </section>` : '';

    const gridHTML = `
    <div id="article-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-16">
        ${gridArticles.map(a => `
        <a href="?view=article&id=${a.id}" class="flex flex-col group cursor-pointer bg-white rounded-sm overflow-hidden hover:shadow-xl transition-all duration-300">
          <div class="overflow-hidden aspect-[16/10] relative">
            <img src="${a.imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"/>
            <div class="absolute top-4 left-4"><span class="bg-white/90 backdrop-blur-sm text-brand-dark text-[10px] font-bold uppercase tracking-widest px-3 py-1.5 shadow-sm rounded-sm">${a.category}</span></div>
          </div>
          <div class="flex flex-col flex-grow p-6">
            <h3 class="text-xl font-display font-bold text-brand-dark mb-3 leading-snug group-hover:text-brand-copper transition-colors">${a.title}</h3>
            <p class="text-brand-steel text-sm line-clamp-3 mb-6 flex-grow leading-relaxed">${a.summary}</p>
            <div class="mt-auto pt-4 border-t border-gray-50 flex items-center text-xs font-bold uppercase tracking-wider text-brand-dark group-hover:text-brand-copper">
               ${t("article.read_story")} <span class="ml-1">→</span>
            </div>
          </div>
        </a>`).join('')}
    </div>`;

    return `
    ${appState.activeCategory === 'All' ? heroHTML : ''}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-24">
        ${featuredHTML}
        <section>
             <div class="flex items-end justify-between mb-12 border-b border-gray-200 pb-6">
                <h2 class="text-3xl font-display font-bold text-brand-dark">${appState.activeCategory === 'All' ? t('section.latest_news') : appState.activeCategory}</h2>
            </div>
            ${gridHTML}
        </section>
    </div>`;
}

// --- VIEW: ARTICLE ---
function renderArticle(id) {
    const article = DATA.articles.find(a => a.id === id);
    if (!article) return `<div class="py-32 text-center text-xl font-bold">Artikel nicht gefunden.</div>`;
    
    // Simple mock progress bar logic can be added via event listener
    return `
    <article class="max-w-6xl mx-auto my-0 bg-white min-h-screen">
        <header class="px-4 py-16 md:py-24 text-center max-w-4xl mx-auto">
           <div class="mb-8"><span class="inline-block px-4 py-1.5 text-xs font-bold uppercase tracking-[0.2em] text-white bg-brand-dark rounded-sm">${article.category}</span></div>
           <h1 class="text-4xl md:text-6xl font-display font-black text-brand-dark leading-[1.1] mb-10 tracking-tight">${article.title}</h1>
           <div class="flex items-center justify-center space-x-8 text-sm text-brand-steel border-t border-b border-gray-100 py-6">
               <span class="font-bold text-brand-dark uppercase tracking-wide text-xs">${article.author}</span>
               <span class="uppercase tracking-wide text-xs">${new Date(article.publishedAt).toLocaleDateString()}</span>
           </div>
        </header>
        ${article.imageUrl ? `<div class="w-full aspect-video md:aspect-[21/9] overflow-hidden bg-gray-100 shadow-sm"><img src="${article.imageUrl}" class="w-full h-full object-cover" /></div>` : ''}
        <div class="px-4 py-16 max-w-4xl mx-auto">
             <div class="prose prose-lg md:prose-xl prose-slate max-w-none text-gray-700 leading-loose prose-headings:font-display prose-headings:font-bold prose-headings:text-brand-dark">
               ${article.content || article.summary}
             </div>
        </div>
    </article>`;
}

// --- VIEW: DIRECTORY ---
function renderDirectory() {
    const t = languageManager.t;
    const businesses = DATA.directory.filter(b => {
        const matchesSearch = !appState.searchQuery || b.name.toLowerCase().includes(appState.searchQuery.toLowerCase()) || b.city.toLowerCase().includes(appState.searchQuery.toLowerCase());
        const matchesCategory = appState.activeCategory === 'All' || b.category === appState.activeCategory;
        return matchesSearch && matchesCategory;
    });
    
    const cats = ['Heizung', 'Sanitär', 'Klima', 'Lüftung', 'Elektro'];

    return `
    <div class="bg-white py-16 md:py-24 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl md:text-6xl font-display font-black text-brand-dark mb-4">${t('directory.title')}</h1>
            <p class="text-lg md:text-xl text-brand-steel max-w-2xl mx-auto">${t('directory.subtitle')}</p>
        </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <!-- Controls -->
        <div class="sticky top-20 z-40 bg-brand-surface/80 backdrop-blur-md p-4 mb-12 rounded-sm border border-gray-200 flex flex-col md:flex-row gap-4 items-center">
            <div class="relative w-full md:w-1/3">
                <input type="text" value="${appState.searchQuery}" oninput="updateSearch(this.value)" placeholder="${t('search.placeholder_dir')}" class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-sm focus:ring-2 focus:ring-brand-copper outline-none" />
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="updateCategory('All')" class="px-4 py-2 text-xs font-bold uppercase tracking-wider rounded-full border transition ${appState.activeCategory === 'All' ? 'bg-brand-dark text-white border-brand-dark' : 'bg-white text-brand-dark border-gray-200 hover:bg-gray-100'}">Alle</button>
                ${cats.map(c => `
                    <button onclick="updateCategory('${c}')" class="px-4 py-2 text-xs font-bold uppercase tracking-wider rounded-full border transition ${appState.activeCategory === c ? 'bg-brand-dark text-white border-brand-dark' : 'bg-white text-brand-dark border-gray-200 hover:bg-gray-100'}">${c}</button>
                `).join('')}
            </div>
        </div>

        <!-- Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            ${businesses.map(b => `
            <div class="bg-white rounded-sm border border-gray-100 p-6 flex flex-col h-full hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                <div class="flex items-start mb-4">
                    <img src="${b.logoUrl || 'https://via.placeholder.com/100'}" class="w-16 h-16 rounded-sm object-contain border border-gray-100 p-1 mr-4 bg-white" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="flex-grow">
                        <h3 class="font-display font-bold text-lg text-brand-dark leading-tight">${b.name}</h3>
                        <span class="mt-1 inline-block text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-sm bg-gray-100 text-gray-800">${b.category}</span>
                    </div>
                </div>
                <p class="text-sm text-brand-steel mb-5 leading-relaxed flex-grow">${b.description}</p>
                <div class="mt-auto space-y-3 text-sm text-brand-steel border-t border-gray-100 pt-5">
                    <div>${b.address}, ${b.zip} ${b.city}</div>
                    <div>${b.phone}</div>
                    ${b.website ? `<a href="${b.website}" target="_blank" class="text-brand-copper hover:underline truncate block">${b.website.replace('https://','')}</a>` : ''}
                </div>
            </div>`).join('')}
            ${businesses.length === 0 ? `<div class="col-span-full text-center py-20 text-gray-400">Keine Betriebe gefunden.</div>` : ''}
        </div>
    </div>`;
}

// --- MAIN CONTROLLER ---

function render() {
    const header = document.getElementById('header-container');
    const main = document.getElementById('main-content');
    const footer = document.getElementById('footer-container');
    const loading = document.getElementById('loading-indicator');

    if (loading) loading.style.display = appState.loading ? 'block' : 'none';

    header.innerHTML = createHeaderHTML(appState.view, appState.activeCategory);
    
    let content = '';
    if (appState.view === 'magazine') content = renderMagazine();
    else if (appState.view === 'article') {
        const urlParams = new URLSearchParams(window.location.search);
        content = renderArticle(urlParams.get('id'));
    }
    else if (appState.view === 'directory') content = renderDirectory();

    main.innerHTML = content;
    footer.innerHTML = createFooterHTML();
}

function router() {
    const urlParams = new URLSearchParams(window.location.search);
    const view = urlParams.get('view') || 'magazine';
    const category = urlParams.get('category') || 'All';
    
    appState.view = view;
    
    // Reset category if switching views, unless param provided
    if (view === 'directory') {
        // Directory handles its own category state internally or via param?
        // Let's allow param override, else default 'All'
        appState.activeCategory = category; 
        appState.searchQuery = '';
    } else {
        appState.activeCategory = category;
    }
    
    render();
}

// --- ACTIONS ---
function updateSearch(val) {
    appState.searchQuery = val;
    render();
}
function updateCategory(cat) {
    appState.activeCategory = cat;
    render();
}

// --- DATA FETCHING ---
async function fetchLiveData() {
    const s = JSON.parse(localStorage.getItem('shk_settings')) || {};
    let hasUpdates = false;
    appState.loading = true;
    render(); // show loading spinner

    // Fetch Articles
    if (s.articlesScriptUrl) {
        try {
            const res = await fetch(s.articlesScriptUrl);
            if (res.ok) {
                const json = await res.json();
                if (json && json.articles) {
                    DATA.articles = json.articles;
                    if(json.categories) DATA.categories = json.categories;
                    hasUpdates = true;
                }
            }
        } catch (e) { console.error("Article fetch failed", e); }
    }

    // Fetch Directory
    if (s.directoryScriptUrl) {
        try {
            const res = await fetch(s.directoryScriptUrl);
            if (res.ok) {
                const json = await res.json();
                // Apps Script might return { directory: [...] } or combined
                if (json && json.directory) {
                    DATA.directory = json.directory;
                    hasUpdates = true;
                }
            }
        } catch (e) { console.error("Directory fetch failed", e); }
    }

    appState.loading = false;
    if (hasUpdates) render();
    else render(); // hide spinner
}

// --- INIT ---
window.addEventListener('popstate', router);
document.addEventListener('DOMContentLoaded', () => {
    // 1. Check for CMS Sync Signal from another tab
    window.addEventListener('storage', (e) => {
        if (e.key === 'shk_articles' || e.key === 'shk_directory') {
            // Can reload from local storage if we wanted to share that way, 
            // but requirements say "inspect article in google drive".
            // However, a 'storage' event usually means CMS saved something locally.
            // If CMS triggered a sync, it might verify via 'shk_settings' or custom event.
            // Let's just re-fetch live data if we detect changes.
            fetchLiveData();
        }
    });

    router();
    fetchLiveData();
});

</script>
</body>
</html>