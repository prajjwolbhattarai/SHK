<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHK Rhein-Neckar | Branchenmagazin & Verzeichnis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      .loader { border-top-color: #b45309; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .fade-in { animation: fadeIn 0.5s ease-out forwards; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Montserrat', 'sans-serif'] },
            colors: { 'brand-dark': '#0f172a', 'brand-copper': '#b45309', 'brand-steel': '#475569', 'brand-surface': '#f8fafc' }
          }
        }
      }
    </script>
</head>
<body class="bg-brand-surface text-slate-900 antialiased selection:bg-brand-copper selection:text-white flex flex-col min-h-screen">
    
    <!-- Header -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow">
        <!-- Content injected by JS -->
        <div class="h-screen flex items-center justify-center">
             <div class="w-8 h-8 border-4 border-brand-copper border-t-transparent rounded-full loader"></div>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer-container"></div>

<script>
// --- 1. INITIAL DATA (Skeleton/Fallback) ---
const SKELETON_DATA = {
    articles: [
        {id:"art-1",type:"article",title:"Neue Energieverordnungen 2025: Was gilt ab Januar?",summary:"Ein umfassender Bericht √ºber die neuen GEG-Vorgaben, F√∂rderungen und was Handwerksbetriebe jetzt wissen m√ºssen.",imageUrl:"https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Redaktion",publishedAt:"2025-10-25",featured:true},
        {id:"art-2",type:"article",title:"R√ºckblick ISH Messe Frankfurt: Die Highlights",summary:"Die wichtigsten Trends der Weltleitmesse f√ºr Wasser, W√§rme, Luft ‚Äì von KI-Steuerung bis Wasserstoff.",imageUrl:"https://images.unsplash.com/photo-1542744173-8e7e53415bb0?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Markus Weber",publishedAt:"2025-10-24",featured:false},
        {id:"art-3",type:"article",title:"Gro√ühandelspreise stabilisieren sich",summary:"Entwarnung f√ºr Handwerksbetriebe: Materialpreise f√ºr Kupfer und Keramik pendeln sich auf Vorkrisenniveau ein.",imageUrl:"https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Julia Schmidt",publishedAt:"2025-10-23",featured:false},
        {id:"art-4",type:"article",title:"Fachkr√§ftemangel: Strategien aus der Region",summary:"Wie Mannheimer Betriebe mit neuen Ausbildungsmodellen erfolgreich Nachwuchs gewinnen.",imageUrl:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&q=80&w=1200",category:"Personal & Karriere",author:"Redaktion",publishedAt:"2025-10-22",featured:false},
        {id:"art-5",type:"article",title:"W√§rmepumpen im Altbau: Ein Praxis-Guide",summary:"Technische L√∂sungen und Argumentationshilfen f√ºr das Kundengespr√§ch.",imageUrl:"https://images.unsplash.com/photo-1581094794329-cd2d2dec5d83?auto=format&fit=crop&q=80&w=1200",category:"Technologie",author:"Hans M√ºller",publishedAt:"2025-10-20",featured:false}
    ],
    directory: [
        {id:"dir-1",name:"Heizungstechnik M√ºller GmbH",category:"Heizung",address:"Hauptstra√üe 10",city:"Mannheim",zip:"68159",phone":"0621 123456",website:"https://heizung-mueller.de",description:"Spezialist f√ºr moderne Heizsysteme und W√§rmepumpen.",logoUrl:"https://logo.clearbit.com/heizung-mueller.de"},
        {id:"dir-2",name:"Sanit√§r-Service Weber",category:"Sanit√§r",address:"Bergheimer Stra√üe 58",city:"Heidelberg",zip:"69115",phone":"06221 654321",website:"https://sanitaer-weber.de",description:"Komplettb√§der aus einer Hand. Barrierefreie Umbauten.",logoUrl:"https://logo.clearbit.com/sanitaer-weber.de"},
        {id:"dir-3",name:"Klima-Profis Rhein-Neckar",category:"Klima",address:"Industriestra√üe 35",city:"Ludwigshafen",zip:"67063",phone":"0621 987654",website:"https://klima-profis-rn.de",description:"Installation und Wartung von Klimaanlagen.",logoUrl:"https://logo.clearbit.com/klima-profis-rn.de"}
    ],
    categories: ['Branchen-News', 'Betriebs-Features', 'Personal & Karriere', 'Technologie', 'Energie & Nachhaltigkeit', 'Regional']
};

let DATA = { ...SKELETON_DATA };
const appState = { view: 'magazine', activeCategory: 'All', searchQuery: '', loading: false };

// --- 2. CONFIG & TRANSLATIONS ---
const translations={
  de:{
    'nav.home':'Startseite','nav.directory':'Verzeichnis','hero.title':'Das f√ºhrende SHK-Branchenmagazin.','hero.subtitle':'Verl√§ssliche Berichterstattung f√ºr Sanit√§r-, Heizungs- und Klimaprofis in der Metropolregion Rhein-Neckar.',
    'hero.submit_story':'Story einreichen','section.top_story':'Top Story','section.latest_news':'Neueste Branchennachrichten','footer.about':'Die unabh√§ngige Stimme f√ºr die SHK-Branche.',
    'article.read_story':'Artikel lesen','directory.title':'Branchenverzeichnis','directory.subtitle':'Finden Sie qualifizierte Fachbetriebe.','search.placeholder_dir':'Suche nach Name oder Stadt...'
  }
};
const t = (k) => translations.de[k] || k;

// --- 3. RENDER FUNCTIONS ---

function renderHeader() {
    const navLink = (view, label, active) => `
        <a href="?view=${view}" class="relative h-full text-xs font-bold uppercase tracking-widest flex items-center transition-colors ${active ? 'text-brand-copper border-b-2 border-brand-copper' : 'text-brand-steel hover:text-brand-dark'}">
            ${label}
        </a>`;

    document.getElementById('header-container').innerHTML = `
    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-20 items-center">
          <a href="?view=magazine" class="flex-shrink-0 flex items-center cursor-pointer">
            <img src="shklogo.jpg" alt="SHK Logo" class="h-10 w-auto object-contain" onerror="this.src='https://via.placeholder.com/150x50?text=SHK+Logo'"/>
          </a>
          <div class="hidden lg:flex space-x-8 items-center h-full">
              ${navLink('magazine', t('nav.home'), appState.view === 'magazine' && appState.activeCategory === 'All')}
              ${navLink('directory', t('nav.directory'), appState.view === 'directory')}
              ${DATA.categories.slice(0, 4).map(c => `
                  <a href="?view=magazine&category=${encodeURIComponent(c)}" class="relative h-full text-xs font-bold uppercase tracking-widest flex items-center transition-colors ${appState.activeCategory === c ? 'text-brand-copper border-b-2 border-brand-copper' : 'text-brand-steel hover:text-brand-dark'}">
                      ${c}
                  </a>
              `).join('')}
          </div>
          <div class="flex items-center space-x-4">
            <div id="live-indicator" class="hidden text-[10px] font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200 uppercase tracking-wide">Live Data</div>
            <div id="loader-indicator" class="${appState.loading ? 'block' : 'hidden'}"><div class="w-4 h-4 border-2 border-brand-copper border-t-transparent rounded-full loader"></div></div>
            <a href="admin.html" class="hidden md:block bg-brand-dark text-white px-5 py-2.5 text-xs font-bold uppercase tracking-wider rounded-sm hover:bg-brand-copper transition">CMS Login</a>
          </div>
        </div>
      </div>
    </nav>`;
}

function renderFooter() {
    document.getElementById('footer-container').innerHTML = `
    <footer class="bg-white border-t border-gray-200 pt-16 pb-8 mt-auto">
      <div class="max-w-7xl mx-auto px-4 text-center md:text-left grid grid-cols-1 md:grid-cols-4 gap-8">
        <div class="col-span-1 md:col-span-2">
            <h4 class="font-display font-black text-xl mb-4 text-brand-dark">SHK Rhein-Neckar</h4>
            <p class="text-sm text-brand-steel leading-relaxed max-w-sm">${t('footer.about')}</p>
        </div>
        <div>
            <h5 class="text-xs font-bold uppercase tracking-widest mb-4 text-brand-dark">Navigation</h5>
            <ul class="space-y-2 text-sm text-brand-steel">
                <li><a href="?view=magazine" class="hover:text-brand-copper">Magazin</a></li>
                <li><a href="?view=directory" class="hover:text-brand-copper">Verzeichnis</a></li>
            </ul>
        </div>
        <div>
            <h5 class="text-xs font-bold uppercase tracking-widest mb-4 text-brand-dark">Kontakt</h5>
            <ul class="space-y-2 text-sm text-brand-steel">
                <li>redaktion@shk-rn.de</li>
                <li>Mannheim, DE</li>
            </ul>
        </div>
      </div>
      <div class="max-w-7xl mx-auto px-4 mt-12 pt-8 border-t border-gray-100 text-center text-xs text-gray-400">
          ¬© 2025 SHK Rhein-Neckar.
      </div>
    </footer>`;
}

function renderMagazine() {
    let articles = DATA.articles;
    if (appState.activeCategory !== 'All') {
        articles = articles.filter(a => a.category === appState.activeCategory);
    }
    const featured = articles.find(a => a.featured && a.imageUrl) || articles[0];
    const gridArticles = articles.filter(a => a.id !== featured?.id);

    // Hero Section
    const hero = appState.activeCategory === 'All' && featured ? `
    <div class="relative w-full h-[500px] bg-brand-dark overflow-hidden group mb-16">
        <img src="${featured.imageUrl}" class="absolute inset-0 w-full h-full object-cover opacity-60 transition-transform duration-1000 group-hover:scale-105" />
        <div class="absolute inset-0 bg-gradient-to-t from-brand-dark via-transparent to-transparent"></div>
        <div class="absolute bottom-0 left-0 p-8 md:p-16 max-w-4xl animate-fade-in-up">
            <span class="inline-block px-3 py-1 mb-4 text-[10px] font-bold uppercase tracking-widest text-white bg-brand-copper rounded-sm">${featured.category}</span>
            <h1 class="text-3xl md:text-5xl lg:text-6xl font-display font-black text-white leading-tight mb-4 drop-shadow-lg">
                <a href="?view=article&id=${featured.id}" class="hover:text-gray-200 transition">${featured.title}</a>
            </h1>
            <p class="text-gray-300 text-lg md:text-xl font-light line-clamp-2 max-w-2xl mb-8">${featured.summary}</p>
            <a href="?view=article&id=${featured.id}" class="inline-block bg-white text-brand-dark px-6 py-3 text-xs font-bold uppercase tracking-wider rounded-sm hover:bg-brand-copper hover:text-white transition">Jetzt lesen</a>
        </div>
    </div>` : `
    <div class="bg-gray-50 py-16 mb-12 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4"><h1 class="text-4xl font-display font-black text-brand-dark">${appState.activeCategory}</h1></div>
    </div>`;

    // Grid
    const grid = `
    <div class="max-w-7xl mx-auto px-4 pb-24">
        <div class="flex items-center justify-between mb-8 border-b border-gray-200 pb-4">
            <h2 class="text-xl font-display font-bold text-brand-dark">${t('section.latest_news')}</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            ${gridArticles.map(a => `
            <a href="?view=article&id=${a.id}" class="group bg-white rounded-sm overflow-hidden border border-transparent hover:border-gray-200 hover:shadow-xl transition-all duration-300 flex flex-col h-full fade-in">
                <div class="aspect-[16/9] overflow-hidden relative bg-gray-100">
                    <img src="${a.imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/400x225'"/>
                    <div class="absolute top-3 left-3 bg-white/90 backdrop-blur text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-sm text-brand-dark">${a.category}</div>
                </div>
                <div class="p-6 flex flex-col flex-grow">
                    <h3 class="text-lg font-bold font-display text-brand-dark mb-3 leading-snug group-hover:text-brand-copper transition-colors">${a.title}</h3>
                    <p class="text-sm text-brand-steel leading-relaxed line-clamp-3 mb-4 flex-grow">${a.summary}</p>
                    <div class="mt-auto pt-4 border-t border-gray-50 flex justify-between items-center text-xs text-gray-400 font-medium">
                        <span class="uppercase tracking-wider group-hover:text-brand-dark transition-colors">Mehr lesen &rarr;</span>
                        <span>${new Date(a.publishedAt).toLocaleDateString()}</span>
                    </div>
                </div>
            </a>`).join('')}
        </div>
    </div>`;

    return hero + grid;
}

function renderArticle(id) {
    const article = DATA.articles.find(a => a.id === id);
    if (!article) return `<div class="py-32 text-center"><h2 class="text-2xl font-bold text-brand-dark">Artikel nicht gefunden.</h2><a href="?view=magazine" class="text-brand-copper underline mt-4 inline-block">Zur√ºck zur √úbersicht</a></div>`;

    return `
    <article class="bg-white min-h-screen fade-in">
        <div class="w-full h-[40vh] md:h-[60vh] relative bg-brand-dark">
            <img src="${article.imageUrl}" class="w-full h-full object-cover opacity-70" onerror="this.src='https://via.placeholder.com/1200x600'"/>
            <div class="absolute inset-0 bg-gradient-to-t from-brand-dark/90 to-transparent"></div>
            <div class="absolute bottom-0 left-0 w-full p-6 md:p-12 pb-16 md:pb-24">
                <div class="max-w-4xl mx-auto text-center">
                    <span class="inline-block px-3 py-1 mb-6 text-xs font-bold uppercase tracking-[0.2em] text-brand-copper bg-white rounded-sm">${article.category}</span>
                    <h1 class="text-3xl md:text-5xl lg:text-6xl font-display font-black text-white leading-tight mb-6">${article.title}</h1>
                    <div class="flex items-center justify-center space-x-6 text-sm font-medium text-gray-300">
                        <span class="flex items-center"><span class="bg-brand-copper w-2 h-2 rounded-full mr-2"></span>${article.author || 'Redaktion'}</span>
                        <span>${new Date(article.publishedAt).toLocaleDateString()}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="max-w-3xl mx-auto px-6 py-16 -mt-10 relative z-10 bg-white rounded-t-lg shadow-sm">
             <div class="prose prose-lg prose-slate max-w-none prose-headings:font-display prose-headings:font-bold prose-a:text-brand-copper">
                ${article.content || `<p class="lead text-xl text-brand-steel font-light leading-relaxed mb-8">${article.summary}</p><p>Inhalt wird geladen...</p>`}
             </div>
             <div class="mt-16 pt-8 border-t border-gray-100 text-center">
                <a href="?view=magazine" class="inline-block px-8 py-3 bg-gray-100 text-brand-dark font-bold uppercase text-xs tracking-widest rounded-sm hover:bg-brand-copper hover:text-white transition">Zur√ºck zum Magazin</a>
             </div>
        </div>
    </article>`;
}

function renderDirectory() {
    const businesses = DATA.directory.filter(b => {
        const q = appState.searchQuery.toLowerCase();
        return (appState.activeCategory === 'All' || b.category === appState.activeCategory) &&
               (!q || b.name.toLowerCase().includes(q) || b.city.toLowerCase().includes(q));
    });

    const cats = ['Heizung', 'Sanit√§r', 'Klima', 'L√ºftung', 'Elektro'];
    
    return `
    <div class="bg-gray-50 py-16 md:py-24 border-b border-gray-200 mb-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-display font-black text-brand-dark mb-4">${t('directory.title')}</h1>
            <p class="text-brand-steel max-w-2xl mx-auto text-lg">${t('directory.subtitle')}</p>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 pb-24">
        <!-- Controls -->
        <div class="bg-white p-4 rounded-sm shadow-sm border border-gray-200 mb-12 flex flex-col md:flex-row gap-4 items-center sticky top-24 z-30">
            <div class="relative w-full md:w-1/3">
                <input type="text" value="${appState.searchQuery}" oninput="updateSearch(this.value)" placeholder="${t('search.placeholder_dir')}" class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-sm focus:border-brand-copper outline-none transition text-sm">
            </div>
            <div class="flex flex-wrap gap-2 justify-center flex-grow">
                <button onclick="updateCategory('All')" class="px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-full border transition ${appState.activeCategory === 'All' ? 'bg-brand-dark text-white border-brand-dark' : 'bg-white hover:bg-gray-50 border-gray-200'}">Alle</button>
                ${cats.map(c => `
                    <button onclick="updateCategory('${c}')" class="px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-full border transition ${appState.activeCategory === c ? 'bg-brand-dark text-white border-brand-dark' : 'bg-white hover:bg-gray-50 border-gray-200'}">${c}</button>
                `).join('')}
            </div>
        </div>

        <!-- Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            ${businesses.map(b => `
            <div class="bg-white p-6 rounded-sm border border-gray-100 hover:shadow-lg hover:border-brand-copper/30 transition-all duration-300 flex flex-col h-full fade-in">
                <div class="flex items-start mb-4">
                    <img src="${b.logoUrl}" class="w-12 h-12 object-contain p-1 border border-gray-100 bg-white rounded-sm mr-3" onerror="this.src='https://via.placeholder.com/64'">
                    <div>
                        <h3 class="font-bold text-brand-dark leading-tight">${b.name}</h3>
                        <span class="text-[10px] uppercase font-bold text-gray-400">${b.category}</span>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mb-4 flex-grow leading-relaxed">${b.description || ''}</p>
                <div class="space-y-1 text-xs text-brand-steel border-t border-gray-50 pt-3">
                    <div class="flex items-center"><span class="w-4 mr-2 text-center opacity-50">üìç</span>${b.city}</div>
                    <div class="flex items-center"><span class="w-4 mr-2 text-center opacity-50">üìû</span>${b.phone}</div>
                    ${b.website ? `<a href="${b.website}" target="_blank" class="flex items-center text-brand-copper hover:underline"><span class="w-4 mr-2 text-center opacity-50">üåê</span>Webseite</a>` : ''}
                </div>
            </div>`).join('')}
            ${businesses.length === 0 ? `<div class="col-span-full text-center py-20 text-gray-400">Keine Ergebnisse gefunden.</div>` : ''}
        </div>
    </div>`;
}

// --- 4. CONTROLLER & LOGIC ---

function render() {
    renderHeader();
    const main = document.getElementById('main-content');
    
    if (appState.view === 'magazine') main.innerHTML = renderMagazine();
    else if (appState.view === 'article') {
        const params = new URLSearchParams(window.location.search);
        main.innerHTML = renderArticle(params.get('id'));
    } 
    else if (appState.view === 'directory') main.innerHTML = renderDirectory();
    
    renderFooter();
}

function router() {
    const params = new URLSearchParams(window.location.search);
    appState.view = params.get('view') || 'magazine';
    
    // If category is in URL, respect it.
    if (params.get('category')) appState.activeCategory = params.get('category');
    
    // If switching to directory, default category to 'All' unless specified
    if (appState.view === 'directory' && !params.get('category')) appState.activeCategory = 'All';

    render();
}

function updateCategory(cat) {
    appState.activeCategory = cat;
    render();
}

function updateSearch(val) {
    appState.searchQuery = val;
    render();
}

// --- 5. DATA FETCHING ---

async function fetchLiveData() {
    appState.loading = true;
    renderHeader(); // update loader

    const settings = JSON.parse(localStorage.getItem('shk_settings')) || {};
    let updated = false;

    // 1. Articles
    if (settings.articlesScriptUrl) {
        try {
            const res = await fetch(settings.articlesScriptUrl);
            if (res.ok) {
                const json = await res.json();
                if (json.articles && Array.isArray(json.articles)) {
                    DATA.articles = json.articles;
                    if(json.categories) DATA.categories = json.categories;
                    updated = true;
                }
            }
        } catch(e) { console.warn('Articles fetch failed', e); }
    }

    // 2. Directory
    if (settings.directoryScriptUrl) {
        try {
            const res = await fetch(settings.directoryScriptUrl);
            if (res.ok) {
                const json = await res.json();
                if (json.directory && Array.isArray(json.directory)) {
                    DATA.directory = json.directory;
                    updated = true;
                }
            }
        } catch(e) { console.warn('Directory fetch failed', e); }
    }

    appState.loading = false;
    if (updated) {
        document.getElementById('live-indicator')?.classList.remove('hidden');
        render();
    } else {
        renderHeader(); // hide loader
    }
}

function loadLocalData() {
    // Attempt to load from localStorage cache (shared with Admin) for instant updates
    const localArts = localStorage.getItem('shk_articles');
    if (localArts) DATA.articles = JSON.parse(localArts);
    
    const localDir = localStorage.getItem('shk_directory');
    if (localDir) DATA.directory = JSON.parse(localDir);
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    loadLocalData(); // 1. Instant load from local
    router();        // 2. Render initial view
    fetchLiveData(); // 3. Fetch live from Google
    
    // Cross-tab sync
    window.addEventListener('storage', () => {
        loadLocalData();
        render();
    });
});
window.addEventListener('popstate', router);

</script>
</body>
</html>