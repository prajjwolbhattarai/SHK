<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS | SHK Rhein-Neckar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Montserrat', 'sans-serif'] },
            colors: { 'brand-dark': '#0f172a', 'brand-copper': '#b45309', 'brand-steel': '#475569', 'brand-surface': '#f8fafc' }
          }
        }
      }
    </script>
    <style>
        .editor-content:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
            display: block;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-brand-dark">
    <div id="app-root"></div>

<script>
// --- V A N I L L A   J S   C M S ---

// --- 1. DATA & STATE STORE ---
let articles = []; 
let directory = [];
let categories = [];
let users = [];
let mediaLibrary = [];
let settings = {
    articlesScriptUrl: 'https://script.google.com/macros/s/AKfycbxiD4ryVZpHISk_L275irKaNb8dRzAmZDCrZQvloe5S_GEaXEVjPp22ECavhF-9KHfSGg/exec',
    gaMeasurementId: '',
    newsletterApiKey: '',
};

const appState = {
    isAuthenticated: false,
    currentUser: null,
    activeView: 'dashboard', 
    modalOpen: false,
    modalType: null, 
    editingItem: null,
    syncState: 'idle'
};
let savedRange; // For editor cursor position

function loadData() {
    const sArticles = localStorage.getItem('shk_articles');
    articles = sArticles ? JSON.parse(sArticles) : [];
    
    const sDirectory = localStorage.getItem('shk_directory');
    directory = sDirectory ? JSON.parse(sDirectory) : [];
    
    const sCategories = localStorage.getItem('shk_categories');
    categories = sCategories ? JSON.parse(sCategories) : [];
    
    const sSettings = localStorage.getItem('shk_settings');
    settings = sSettings ? JSON.parse(sSettings) : settings;
    
    const sUsers = localStorage.getItem('shk_users');
    users = sUsers ? JSON.parse(sUsers) : [];

    const sMedia = localStorage.getItem('shk_media');
    mediaLibrary = sMedia ? JSON.parse(sMedia) : [];

    if (articles.length === 0 || directory.length === 0 || categories.length === 0) {
      seedMockData();
    }
    if (users.length === 0) seedUsers();
    if (mediaLibrary.length === 0) seedMedia();
}

function saveData() {
    localStorage.setItem('shk_articles', JSON.stringify(articles));
    localStorage.setItem('shk_directory', JSON.stringify(directory));
    localStorage.setItem('shk_categories', JSON.stringify(categories));
    localStorage.setItem('shk_settings', JSON.stringify(settings));
    localStorage.setItem('shk_users', JSON.stringify(users));
    localStorage.setItem('shk_media', JSON.stringify(mediaLibrary));
}

function seedMockData() {
    categories = ['Branchen-News', 'Betriebs-Features', 'Personal & Karriere', 'Technologie', 'Energie & Nachhaltigkeit', 'Regional'];

    const generateContent = (title, topic) => `
      <p class="lead">Ein exklusiver Bericht von SHK Rhein-Neckar zum Thema <strong>${topic}</strong>. Erfahren Sie, welche Auswirkungen die aktuellen Entwicklungen auf das Handwerk in der Metropolregion haben.</p>
      <h2>Hintergrund und aktuelle Lage</h2>
      <p>Die SHK-Branche steht vor großen Herausforderungen und Chancen. Die ${topic} ist dabei ein zentraler Punkt, der Betriebe in Mannheim, Heidelberg und Ludwigshafen gleichermaßen beschäftigt. Wir haben mit Experten gesprochen und die wichtigsten Fakten für Sie zusammengefasst.</p>
      <h3>Was bedeutet das für Ihren Betrieb?</h3>
      <p>Konkret müssen Handwerksbetriebe jetzt handeln. Die Anpassung an neue Vorschriften und Technologien ist unerlässlich, um wettbewerbsfähig zu bleiben. Dies betrifft sowohl die technische Ausstattung als auch die Weiterbildung der Mitarbeiter.</p>
      <blockquote>"Wer jetzt die Weichen richtig stellt, sichert sich die Aufträge von morgen." – Zitat eines Innungsmeisters aus der Region.</blockquote>
      <h4>Checkliste für die Praxis:</h4>
      <ul><li>Analyse des eigenen Betriebs im Hinblick auf ${topic}.</li><li>Investitionsplan für neue Technologien erstellen.</li><li>Weiterbildungsmaßnahmen für Mitarbeiter planen und umsetzen.</li><li>Kunden proaktiv über neue Möglichkeiten und gesetzliche Anforderungen informieren.</li></ul>
      <p>Bleiben Sie dran für weitere Analysen und Praxisbeispiele hier im SHK Rhein-Neckar Magazin.</p>`;
    
    let tempArticles = [
        { id: 'art-1', type: 'article', title: 'Die neue BAFA-Förderung für Wärmepumpen 2025: Was sich jetzt ändert', summary: 'Bis zu 70% Zuschuss sind möglich, doch die Antragsbedingungen wurden verschärft. Wir zeigen, worauf Betriebe und Kunden achten müssen.', content: generateContent('BAFA-Förderung 2025', 'Wärmepumpen-Subventionen'), imageUrl: 'https://images.unsplash.com/photo-1632558555363-8e13511b9b53?auto=format&fit=crop&q=80&w=1200', category: 'Energie & Nachhaltigkeit', author: 'Julia Schmidt', publishedAt: new Date(Date.now() - 86400000 * 2).toISOString(), featured: true, status: 'published', views: 4812, shares: 215, readTime: 300, slug: 'bafa-foerderung-waermepumpen-2025', metaTitle: 'BAFA-Förderung Wärmepumpen 2025 | SHK Magazin', metaDescription: 'Alle Änderungen der BAFA-Förderung für Wärmepumpen ab 2025. Ein Leitfaden für Handwerker und Endkunden.', tags: ['Förderung', 'Wärmepumpe', 'BAFA'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-2', type: 'article', title: 'Azubi-Recruiting 2.0: Wie SHK-Betriebe auf Instagram und TikTok punkten', summary: 'Der Kampf um Nachwuchskräfte ist in vollem Gange. Ein Heidelberger Betrieb zeigt, wie man mit kreativen Social-Media-Kampagnen die Generation Z erreicht.', content: generateContent('Azubi-Recruiting 2.0', 'Nachwuchsgewinnung'), imageUrl: 'https://images.unsplash.com/photo-1611162616475-46b635cb6868?auto=format&fit=crop&q=80&w=1200', category: 'Personal & Karriere', author: 'Markus Weber', publishedAt: new Date(Date.now() - 86400000 * 5).toISOString(), featured: false, status: 'published', views: 2345, shares: 120, readTime: 240, slug: 'azubi-recruiting-social-media', metaTitle: 'Azubi-Recruiting auf TikTok & Instagram', metaDescription: 'Erfolgsstrategien für SHK-Betriebe zur Gewinnung von Auszubildenden über Social Media.', tags: ['Azubi', 'Recruiting', 'Social Media'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-3', type: 'article', title: 'Digitales Aufmaß per App: 5 Werkzeuge im Praxistest', summary: 'Zollstock und Klemmbrett waren gestern. Wir haben fünf führende Apps für das digitale Aufmaß auf der Baustelle getestet und vergleichen Funktionen, Preise und Benutzerfreundlichkeit.', content: generateContent('Digitales Aufmaß per App', 'digitale Werkzeuge'), imageUrl: 'https://images.unsplash.com/photo-1581092446347-a5a1f3a2c6f2?auto=format&fit=crop&q=80&w=1200', category: 'Technologie', author: 'Redaktion', publishedAt: new Date(Date.now() - 86400000 * 8).toISOString(), featured: false, status: 'published', views: 1987, shares: 95, readTime: 360, slug: 'digitales-aufmass-apps-test', metaTitle: 'Test: Apps für digitales Aufmaß', metaDescription: 'Ein Vergleich von 5 Apps für das digitale Aufmaß im SHK-Handwerk.', tags: ['Digitalisierung', 'App', 'Aufmaß'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-4', type: 'article', title: 'Betriebs-Feature: Firma Sanitär-Schulze aus Heidelberg meistert die 4-Tage-Woche', summary: 'Weniger Arbeitszeit bei vollem Lohnausgleich – kann das im Handwerk funktionieren? Die Firma Schulze hat es gewagt und zieht nach einem Jahr Bilanz.', content: generateContent('4-Tage-Woche im Handwerk', 'Arbeitszeitmodelle'), imageUrl: 'https://images.unsplash.com/photo-1552664730-d307ca884978?auto=format&fit=crop&q=80&w=1200', category: 'Betriebs-Features', author: 'Julia Schmidt', publishedAt: new Date(Date.now() - 86400000 * 12).toISOString(), featured: false, status: 'published', views: 3120, shares: 180, readTime: 280, slug: 'feature-sanitaer-schulze-4-tage-woche', metaTitle: 'Sanitär Schulze: Erfolg mit 4-Tage-Woche', metaDescription: 'Ein Betriebs-Feature über die Einführung der 4-Tage-Woche bei einem SHK-Betrieb in Heidelberg.', tags: ['Arbeitszeit', 'New Work', 'Betriebsführung'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-5', type: 'article', title: 'Neue Trinkwasserverordnung (TrinkwV): Strengere Grenzwerte und Prüfpflichten', summary: 'Seit diesem Jahr gelten neue Regeln für die Trinkwasserinstallation. Was sich bei Legionellenprüfung, Materialien und Dokumentation geändert hat.', content: generateContent('Neue Trinkwasserverordnung', 'Gesetze und Normen'), imageUrl: 'https://images.unsplash.com/photo-1594903335804-6a09a5c75464?auto=format&fit=crop&q=80&w=1200', category: 'Branchen-News', author: 'Redaktion', publishedAt: new Date(Date.now() - 86400000 * 15).toISOString(), featured: false, status: 'published', views: 2890, shares: 155, readTime: 220, slug: 'neue-trinkwasserverordnung', metaTitle: 'Trinkwasserverordnung: Die Änderungen', metaDescription: 'Ein Überblick über die wichtigsten Änderungen der neuen Trinkwasserverordnung für Installateure.', tags: ['Trinkwasser', 'Gesetz', 'Hygiene'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-6', type: 'article', title: 'Smart-Home im Bad: Intelligente WCs und digitale Armaturen im Kommen', summary: 'Das Badezimmer wird smart. Wir zeigen die neuesten Trends von der Dusch-App bis zum sprachgesteuerten Wasserhahn und erörtern die Chancen für das Fachhandwerk.', content: generateContent('Smart-Home im Bad', 'Badezimmer-Technologie'), imageUrl: 'https://images.unsplash.com/photo-1586798271654-0513903a3a5f?auto=format&fit=crop&q=80&w=1200', category: 'Technologie', author: 'Markus Weber', publishedAt: new Date(Date.now() - 86400000 * 20).toISOString(), featured: false, status: 'published', views: 1540, shares: 70, readTime: 180, slug: 'smart-home-bad-trends', metaTitle: 'Trends im Smart-Bad', metaDescription: 'Die neuesten Smart-Home-Technologien für das Badezimmer und ihre Relevanz für SHK-Betriebe.', tags: ['Smart Home', 'Bad', 'IoT'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-7', type: 'article', title: 'Großprojekt in Mannheim: Die Rolle der SHK-Branche bei der Sanierung des Quartiers Franklin', summary: 'Ein Blick hinter die Kulissen eines der größten Bauvorhaben der Region. Welche SHK-Technik kommt zum Einsatz und welche Betriebe sind beteiligt?', content: generateContent('Sanierung Franklin Mannheim', 'Regionalprojekte'), imageUrl: 'https://images.unsplash.com/photo-1504917595217-d4dc5ebe6122?auto=format&fit=crop&q=80&w=1200', category: 'Regional', author: 'Redaktion', publishedAt: new Date(Date.now() - 86400000 * 25).toISOString(), featured: false, status: 'published', views: 4200, shares: 250, readTime: 320, slug: 'projekt-franklin-mannheim-shk', metaTitle: 'SHK-Technik im Franklin-Quartier', metaDescription: 'Ein Bericht über die Sanitär-, Heizungs- und Klimatechnik im Mannheimer Franklin-Quartier.', tags: ['Mannheim', 'Großprojekt', 'Sanierung'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-8', type: 'article', title: 'Heizen ohne Gas und Öl: Alternativen von Pellet bis Wasserstoff im Überblick', summary: 'Die Energiewende zwingt zum Umdenken. Wir vergleichen die gängigsten Alternativen zu fossilen Brennstoffen im Hinblick auf Kosten, Effizienz und Zukunftsfähigkeit.', content: generateContent('Heizen ohne Gas und Öl', 'alternative Heizsysteme'), imageUrl: 'https://images.unsplash.com/photo-1621233923627-12820330df87?auto=format&fit=crop&q=80&w=1200', category: 'Energie & Nachhaltigkeit', author: 'Julia Schmidt', publishedAt: new Date(Date.now() - 86400000 * 30).toISOString(), featured: false, status: 'published', views: 3850, shares: 205, readTime: 400, slug: 'heizen-alternativen-gas-oel', metaTitle: 'Alternative Heizsysteme im Vergleich', metaDescription: 'Ein umfassender Vergleich von Heizungsalternativen wie Pellet, Solarthermie und Wasserstoff.', tags: ['Heizung', 'Energiewende', 'Technik'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-9', type: 'article', title: 'Fachkräftemangel bekämpfen: Quereinsteiger erfolgreich integrieren', summary: 'Neue Wege im Recruiting: Wie SHK-Betriebe erfolgreich Personal aus anderen Branchen gewinnen und qualifizieren können. Ein Leitfaden mit Praxisbeispielen.', content: generateContent('Quereinsteiger im Handwerk', 'Fachkräftemangel'), imageUrl: 'https://images.unsplash.com/photo-1521791136064-7986c2920216?auto=format&fit=crop&q=80&w=1200', category: 'Personal & Karriere', author: 'Markus Weber', publishedAt: new Date(Date.now() - 86400000 * 35).toISOString(), featured: false, status: 'published', views: 2150, shares: 110, readTime: 260, slug: 'quereinsteiger-shk-integrieren', metaTitle: 'Quereinsteiger im SHK-Handwerk', metaDescription: 'So gelingt die Integration von Quereinsteigern in SHK-Betrieben zur Bekämpfung des Fachkräftemangels.', tags: ['Fachkräfte', 'Quereinsteiger', 'HR'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] },
        { id: 'art-10', type: 'article', title: 'Kundenkommunikation per WhatsApp & Co: Chancen und rechtliche Fallstricke', summary: 'Schnell, direkt und persönlich: Messenger-Dienste verändern die Kundenkommunikation. Was ist erlaubt, worauf müssen Betriebe achten und welche Tools helfen?', content: generateContent('Kundenkommunikation per WhatsApp', 'digitale Kundenbindung'), imageUrl: 'https://images.unsplash.com/photo-1633356122544-f134324a6cee?auto=format&fit=crop&q=80&w=1200', category: 'Branchen-News', author: 'Redaktion', publishedAt: new Date(Date.now() - 86400000 * 40).toISOString(), featured: false, status: 'published', views: 1890, shares: 85, readTime: 190, slug: 'whatsapp-kundenkommunikation-handwerk', metaTitle: 'WhatsApp im Handwerk: Recht & Praxis', metaDescription: 'Praxistipps und rechtliche Hinweise zur Nutzung von WhatsApp in der Kundenkommunikation für SHK-Betriebe.', tags: ['Kommunikation', 'DSGVO', 'Digitalisierung'], revisions: [{date: new Date().toISOString(), user: 'System', note: 'Initial Seed'}] }
    ];

    tempArticles.push(
      { id: 'page-imprint', type: 'page', title: 'Impressum', summary: 'Rechtliche Informationen', content: `<h2>Impressum</h2><p><strong>Angaben gemäß § 5 TMG</strong></p><p>SHK Rhein-Neckar Magazin GmbH<br>Wasserturmstraße 12<br>68161 Mannheim<br>Deutschland</p><p><strong>Vertreten durch:</strong><br>Max Mustermann</p><p><strong>Kontakt:</strong><br>Telefon: +49 (0) 621 12345-0<br>E-Mail: kontakt@shk-rhein-neckar.de</p>`, imageUrl: 'https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&q=80&w=1200', category: 'Page', author: 'Admin', publishedAt: new Date().toISOString(), status: 'published', featured: false, views: 0, shares: 0, readTime: 0 },
      { id: 'page-privacy', type: 'page', title: 'Datenschutzerklärung', summary: 'Datenschutz', content: '<h2>Datenschutz</h2><p>Wir nehmen den Schutz Ihrer Daten ernst...</p>', imageUrl: 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&q=80&w=1200', category: 'Page', author: 'Admin', publishedAt: new Date().toISOString(), status: 'published', featured: false, views: 0, shares: 0, readTime: 0 },
      { id: 'page-terms', type: 'page', title: 'AGB', summary: 'Allgemeine Geschäftsbedingungen', content: '<h2>AGB</h2><p>Allgemeine Geschäftsbedingungen für die Nutzung...</p>', imageUrl: 'https://images.unsplash.com/photo-1450101499163-c8848c66ca85?auto=format&fit=crop&q=80&w=1200', category: 'Page', author: 'Admin', publishedAt: new Date().toISOString(), status: 'published', featured: false, views: 0, shares: 0, readTime: 0 },
      { id: 'page-submit', type: 'page', title: 'Story einreichen', summary: 'Senden Sie uns Ihre Story', content: `<h2>Ihre Geschichte im Magazin</h2><p>Senden Sie uns Ihre Projektberichte an <a href="mailto:redaktion@shk-rhein-neckar.de">redaktion@shk-rhein-neckar.de</a></p>`, imageUrl: 'https://images.unsplash.com/photo-1512486130939-2c4f79935e4f?auto=format&fit=crop&q=80&w=1200', category: 'Page', author: 'Redaktion', publishedAt: new Date().toISOString(), status: 'published', featured: false, views: 0, shares: 0, readTime: 0 },
      { id: 'page-advertising', type: 'page', title: 'Werben & Partner', summary: 'Werbemöglichkeiten', content: `<h2>Media-Daten</h2><p>Erreichen Sie 5000+ Fachkräfte. Kontakt: <a href="mailto:ads@shk-rhein-neckar.de">ads@shk-rhein-neckar.de</a></p>`, imageUrl: 'https://images.unsplash.com/photo-1557804506-669a67965ba0?auto=format&fit=crop&q=80&w=1200', category: 'Page', author: 'Sales', publishedAt: new Date().toISOString(), status: 'published', featured: false, views: 0, shares: 0, readTime: 0 },
      { id: 'page-jobs', type: 'page', title: 'Stellenmarkt', summary: 'Jobs in der Region', content: `<h2>SHK Jobs Rhein-Neckar</h2><p>Inserieren Sie hier. Kontakt: <a href="mailto:jobs@shk-rhein-neckar.de">jobs@shk-rhein-neckar.de</a></p>`, imageUrl: 'https://images.unsplash.com/photo-1521791136064-7986c2920216?auto=format&fit=crop&q=80&w=1200', category: 'Page', author: 'HR', publishedAt: new Date().toISOString(), status: 'published', featured: false, views: 0, shares: 0, readTime: 0 }
    );
    articles = tempArticles;
    
    directory = [
      { id: 'dir-1', name: 'Heizungstechnik Müller GmbH', category: 'Heizung', address: 'Hauptstraße 10', city: 'Mannheim', zip: '68159', phone: '0621 123456', website: 'https://heizung-mueller.de', description: 'Spezialist für moderne Heizsysteme und Wärmepumpen.', logoUrl: 'https://logo.clearbit.com/heizung-mueller.de' },
      { id: 'dir-2', name: 'Sanitär-Service Weber', category: 'Sanitär', address: 'Bergheimer Straße 58', city: 'Heidelberg', zip: '69115', phone: '06221 654321', website: 'https://sanitaer-weber.de', description: 'Komplettbäder aus einer Hand. Barrierefreie Umbauten.', logoUrl: 'https://logo.clearbit.com/sanitaer-weber.de' },
      { id: 'dir-3', name: 'Klima-Profis Rhein-Neckar', category: 'Klima', address: 'Industriestraße 35', city: 'Ludwigshafen', zip: '67063', phone: '0621 987654', website: 'https://klima-profis-rn.de', description: 'Installation und Wartung von Klimaanlagen für Gewerbe und Privat.', logoUrl: 'https://logo.clearbit.com/klima-profis-rn.de' },
      { id: 'dir-4', name: 'Lüftungsbau Schmidt', category: 'Lüftung', address: 'Mittelstraße 5', city: 'Weinheim', zip: '69469', phone: '06201 123789', website: 'https://lueftung-schmidt.de', description: 'Planung und Einbau von zentralen und dezentralen Lüftungsanlagen.', logoUrl: 'https://logo.clearbit.com/lueftung-schmidt.de' },
      { id: 'dir-5', name: 'Elektro-Technik Fischer', category: 'Elektro', address: 'Schulstraße 21', city: 'Schwetzingen', zip: '68723', phone: '06202 987123', website: 'https://elektro-fischer.com', description: 'Smart Home Installationen und Photovoltaik-Anlagen.', logoUrl: 'https://logo.clearbit.com/elektro-fischer.com' },
      { id: 'dir-6', name: 'Bade-Träume GmbH', category: 'Sanitär', address: 'Planken 4', city: 'Mannheim', zip: '68161', phone: '0621 555666', website: 'https://badetraeume-ma.de', description: 'Exklusive Badgestaltung und hochwertige Armaturen.', logoUrl: 'https://logo.clearbit.com/badetraeume-ma.de' },
      { id: 'dir-7', name: 'Wärme-Konzept Rhein-Neckar', category: 'Heizung', address: 'Kurfürsten-Anlage 1', city: 'Heidelberg', zip: '69115', phone: '06221 777888', website: 'https://waerme-konzept-hd.de', description: 'Energieberatung und hydraulischer Abgleich.', logoUrl: 'https://logo.clearbit.com/waerme-konzept-hd.de' },
      { id: 'dir-8', name: 'Frische Luft Systeme', category: 'Lüftung', address: 'Bürgermeister-Grünzweig-Straße 11', city: 'Ludwigshafen', zip: '67059', phone: '0621 333444', website: 'https://frischeluft-lu.de', description: 'Spezialist für Wohnraumlüftung mit Wärmerückgewinnung.', logoUrl: 'https://logo.clearbit.com/frischeluft-lu.de' },
      { id: 'dir-9', name: 'Solar & Strom Wagner', category: 'Elektro', address: 'Mannheimer Landstraße 2', city: 'Hockenheim', zip: '68766', phone: '06205 222333', website: 'https://solar-wagner.de', description: 'Installation von PV-Anlagen und Stromspeichern.', logoUrl: 'https://logo.clearbit.com/solar-wagner.de' },
      { id: 'dir-10', name: 'Haustechnik Klein', category: 'Heizung', address: 'Bahnhofstraße 40', city: 'Sinsheim', zip: '74889', phone: '07261 444555', website: 'https://haustechnik-klein.de', description: '24h Notdienst für Heizung und Sanitär.', logoUrl: 'https://logo.clearbit.com/haustechnik-klein.de' },
      { id: 'dir-11', name: 'Die Bad-Designer', category: 'Sanitär', address: 'Rohrbacher Str. 12', city: 'Heidelberg', zip: '69115', phone: '06221 666777', website: 'https://die-baddesigner.de', description: 'Individuelle Badplanung in 3D.', logoUrl: 'https://logo.clearbit.com/die-baddesigner.de' },
      { id: 'dir-12', name: 'Kühltechnik Becker', category: 'Klima', address: 'Friedrich-Ebert-Straße 1', city: 'Viernheim', zip: '68519', phone: '06204 888999', website: 'https://kuehltechnik-becker.de', description: 'Klimatisierung für Serverräume und Gewerbe.', logoUrl: 'https://logo.clearbit.com/kuehltechnik-becker.de' },
      { id: 'dir-13', name: 'Elektro Bauer & Söhne', category: 'Elektro', address: 'Marktplatz 9', city: 'Worms', zip: '67547', phone: '06241 111222', website: 'https://elektro-bauer.de', description: 'Traditionsbetrieb seit 1950.', logoUrl: 'https://logo.clearbit.com/elektro-bauer.de' },
      { id: 'dir-14', name: 'Pellet-Heizungen Frank', category: 'Heizung', address: 'Odenwaldstraße 22', city: 'Eberbach', zip: '69412', phone: '06271 333444', website: 'https://pellet-frank.de', description: 'Biomasse-Heizungen und Pelletlager.', logoUrl: 'https://logo.clearbit.com/pellet-frank.de' },
      { id: 'dir-15', name: 'Wasser-Welt Ludwigshafen', category: 'Sanitär', address: 'Rheinuferstraße 7', city: 'Ludwigshafen', zip: '67061', phone: '0621 555111', website: 'https://wasser-welt-lu.de', description: 'Wasseraufbereitung und Legionellenprüfung.', logoUrl: 'https://logo.clearbit.com/wasser-welt-lu.de' },
      { id: 'dir-16', name: 'Air-Control GmbH', category: 'Klima', address: 'Augustaanlage 30', city: 'Mannheim', zip: '68165', phone: '0621 222888', website: 'https://air-control-ma.de', description: 'Großanlagen für Bürogebäude und Industrie.', logoUrl: 'https://logo.clearbit.com/air-control-ma.de' },
      { id: 'dir-17', name: 'Licht & Kraft Elektroservice', category: 'Elektro', address: 'Hauptstraße 100', city: 'Wiesloch', zip: '69168', phone: '06222 777999', website: 'https://licht-kraft-wiesloch.de', description: 'E-Ladesäulen und Netzwerktechnik.', logoUrl: 'https://logo.clearbit.com/licht-kraft-wiesloch.de' },
      { id: 'dir-18', name: 'Heizungs-Notdienst 24/7', category: 'Heizung', address: 'Mobil in der Region', city: 'Rhein-Neckar', zip: '68159', phone: '0176 12345678', website: 'https://notdienst-shk-rn.de', description: 'Soforthilfe bei Heizungsausfall.', logoUrl: 'https://logo.clearbit.com/notdienst-shk-rn.de' },
      { id: 'dir-19', name: 'Bad & Fliese Lehmann', category: 'Sanitär', address: 'Industriestraße 8', city: 'Speyer', zip: '67346', phone: '06232 444333', website: 'https://bad-lehmann.de', description: 'Komplettsanierung inklusive Fliesenarbeiten.', logoUrl: 'https://logo.clearbit.com/bad-lehmann.de' },
      { id: 'dir-20', name: 'Energietechnik Vogel', category: 'Heizung', address: 'Schlossstraße 3', city: 'Bruchsal', zip: '76646', phone: '07251 222111', website: 'https://energietechnik-vogel.de', description: 'Experte für Solarthermie und Blockheizkraftwerke.', logoUrl: 'https://logo.clearbit.com/energietechnik-vogel.de' },
    ];
    saveData();
}

function seedUsers() {
    users = [
        { id: 'u1', name: 'Admin User', role: 'Administrator', email: 'admin@shk-rn.de', bio: 'Chief Editor', avatar: 'https://ui-avatars.com/api/?name=Admin+User' },
        { id: 'u2', name: 'Sarah Editor', role: 'Editor', email: 'sarah@shk-rn.de', bio: 'Senior Editor', avatar: 'https://ui-avatars.com/api/?name=Sarah+Editor' },
        { id: 'u3', name: 'Tom Contributor', role: 'Contributor', email: 'tom@shk-rn.de', bio: 'Freelancer', avatar: 'https://ui-avatars.com/api/?name=Tom+Contributor' }
    ];
}

function seedMedia() {
    mediaLibrary = [
        { id: 'm1', name: 'Heat Pump Hero', url: 'https://images.unsplash.com/photo-1581092334651-ddf26d9a09d0?auto=format&fit=crop&q=80&w=300', date: new Date().toISOString() },
        { id: 'm2', name: 'Solar Roof', url: 'https://images.unsplash.com/photo-1509391366360-2e959784a276?auto=format&fit=crop&q=80&w=300', date: new Date().toISOString() }
    ];
}

// --- 2. RENDER ENGINE ---

function render() {
    const root = document.getElementById('app-root');
    const authUser = sessionStorage.getItem('shk_auth_user');
    appState.currentUser = authUser ? JSON.parse(authUser) : null;
    appState.isAuthenticated = !!appState.currentUser;

    if (!appState.isAuthenticated) {
        root.innerHTML = renderLogin();
        attachLoginListeners();
    } else {
        root.innerHTML = `
            <div class="flex h-screen overflow-hidden">
                ${renderSidebar()}
                <div class="relative flex flex-col flex-1 overflow-y-auto overflow-x-hidden">
                    ${renderHeader()}
                    <main class="w-full flex-grow p-6">
                        ${renderMainContent()}
                    </main>
                </div>
            </div>
            ${appState.modalOpen ? renderModal() : ''}
        `;
        lucide.createIcons();
        if (appState.activeView === 'editor') {
            attachEditorEventListeners();
        }
    }
}

// --- 3. TEMPLATES ---

function renderLogin() {
    return `
    <div class="min-h-screen bg-brand-dark flex flex-col justify-center items-center p-4">
        <div class="bg-white w-full max-w-sm rounded-sm shadow-2xl p-8">
            <div class="text-center mb-8">
                <img src="shklogo.jpg" alt="Logo" class="h-16 mx-auto mb-2"/>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Internal CMS</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Demo User</label>
                    <select id="login-user-select" class="w-full border border-gray-300 p-3 rounded-sm text-sm outline-none focus:border-brand-copper">
                        ${users.map(u => `<option value='${JSON.stringify(u)}'>${u.name} (${u.role})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                    <input type="password" id="password" class="w-full border border-gray-300 p-3 rounded-sm text-sm focus:border-brand-copper outline-none" placeholder="Any password works" required>
                </div>
                <button type="submit" class="w-full bg-brand-dark text-white py-3 rounded-sm font-bold uppercase text-xs tracking-wider hover:bg-brand-copper transition">Sign In</button>
            </form>
        </div>
    </div>`;
}

function renderSidebar() {
    const role = appState.currentUser.role;
    const navItem = (id, icon, label) => `
        <button onclick="navigate('${id}')" class="flex items-center w-full px-6 py-3 text-sm font-medium transition-colors duration-200 ${appState.activeView === id ? 'bg-brand-copper text-white' : 'text-gray-400 hover:text-white hover:bg-white/5'}">
            <i data-lucide="${icon}" class="w-4 h-4 mr-3"></i> ${label}
        </button>`;

    return `
    <aside class="flex flex-col w-64 bg-brand-dark border-r border-gray-800 flex-shrink-0">
        <div class="flex items-center justify-center h-20 border-b border-gray-800">
             <img src="shklogo.jpg" alt="Logo" class="h-8 bg-white p-1 rounded-sm"/>
        </div>
        <div class="flex flex-col flex-grow py-4 space-y-1 overflow-y-auto no-scrollbar">
            ${navItem('dashboard', 'layout-dashboard', 'Dashboard')}
            ${navItem('articles', 'file-text', 'Articles')}
            ${navItem('pages', 'layout', 'Pages')}
            ${navItem('media', 'image', 'Media Library')}
            ${navItem('directory', 'building-2', 'Directory')}
            
            ${['Administrator', 'Editor'].includes(role) ? `
                <div class="pt-4 mt-4 border-t border-gray-800">
                    <p class="px-6 text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Admin</p>
                    ${navItem('categories', 'tag', 'Categories')}
                    ${role === 'Administrator' ? navItem('users', 'users', 'Users') : ''}
                    ${role === 'Administrator' ? navItem('settings', 'settings', 'Settings') : ''}
                </div>
            ` : ''}
        </div>
        <div class="p-4 border-t border-gray-800">
            <button onclick="logout()" class="flex items-center w-full text-gray-400 hover:text-white transition text-xs font-bold uppercase tracking-wider">
                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
            </button>
        </div>
    </aside>`;
}

function renderHeader() {
    const u = appState.currentUser;
    return `
    <header class="flex items-center justify-between px-6 py-4 bg-white border-b border-gray-200 sticky top-0 z-40">
        <h2 class="text-xl font-bold text-gray-800 capitalize">${appState.activeView.replace('-', ' ')}</h2>
        <div class="flex items-center space-x-4">
             <span class="text-xs font-bold text-brand-copper bg-orange-50 px-2 py-1 rounded border border-orange-100">${u.role}</span>
             <div class="flex items-center space-x-2">
                <img src="${u.avatar}" class="w-8 h-8 rounded-full border border-gray-200">
                <span class="text-sm font-medium text-gray-700 hidden md:block">${u.name}</span>
             </div>
        </div>
    </header>`;
}

function renderMainContent() {
    switch (appState.activeView) {
        case 'dashboard': return renderDashboard();
        case 'articles': return renderContentList('article');
        case 'pages': return renderContentList('page');
        case 'editor': return renderEditor();
        case 'media': return renderMediaLibrary();
        case 'categories': return renderCategories();
        case 'directory': return renderDirectory();
        case 'users': return renderUsers();
        case 'settings': return renderSettings();
        default: return renderDashboard();
    }
}

// --- VIEW: DASHBOARD ---
function renderDashboard() {
    const totalViews = articles.reduce((acc, curr) => acc + (curr.views || 0), 0);
    const pubArticles = articles.filter(a => a.type === 'article' && a.status === 'published').length;
    const drafts = articles.filter(a => a.type === 'article' && a.status === 'draft').length;
    
    // Simple SVG Sparkline
    const points = [20, 45, 30, 60, 50, 80, 65, 90, 85, 100];
    const path = points.map((val, i) => `${i * 100},${100 - val}`).join(' L ');
    
    return `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-sm shadow-sm border border-gray-200">
            <div class="flex justify-between items-start mb-4">
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total Visits</p><h3 class="text-3xl font-bold text-brand-dark mt-1">${totalViews.toLocaleString()}</h3></div>
                <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="bar-chart-2" class="w-5 h-5"></i></div>
            </div>
            ${settings.gaMeasurementId ? '<p class="text-[10px] text-green-600 font-bold">Live Data Active</p>' : '<p class="text-[10px] text-gray-400">Mock Data</p>'}
        </div>
        <div class="bg-white p-6 rounded-sm shadow-sm border border-gray-200">
            <div class="flex justify-between items-start mb-4">
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Published</p><h3 class="text-3xl font-bold text-brand-dark mt-1">${pubArticles}</h3></div>
                <div class="p-2 bg-green-50 text-green-600 rounded-lg"><i data-lucide="file-check" class="w-5 h-5"></i></div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-sm shadow-sm border border-gray-200">
            <div class="flex justify-between items-start mb-4">
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Drafts</p><h3 class="text-3xl font-bold text-brand-dark mt-1">${drafts}</h3></div>
                <div class="p-2 bg-yellow-50 text-yellow-600 rounded-lg"><i data-lucide="file-edit" class="w-5 h-5"></i></div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-sm shadow-sm border border-gray-200">
            <div class="flex justify-between items-start mb-4">
                <div><p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Directory</p><h3 class="text-3xl font-bold text-brand-dark mt-1">${directory.length}</h3></div>
                <div class="p-2 bg-orange-50 text-brand-copper rounded-lg"><i data-lucide="building-2" class="w-5 h-5"></i></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-6 rounded-sm shadow-sm border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-6 flex justify-between">
                <span>Performance</span>
                <span class="text-xs font-normal text-gray-500">Last 30 Days</span>
            </h3>
            <div class="relative h-64 w-full">
                <svg viewBox="0 0 900 100" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                    <path d="M 0,${100 - points[0]} L ${path}" fill="none" stroke="#b45309" stroke-width="3" vector-effect="non-scaling-stroke" />
                    <path d="M 0,${100 - points[0]} L ${path} L 900,100 L 0,100 Z" fill="url(#gradient)" opacity="0.1" vector-effect="non-scaling-stroke" />
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#b45309;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#b45309;stop-opacity:0" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div class="grid grid-cols-3 gap-4 mt-6 text-center text-sm border-t pt-4">
                <div><span class="block font-bold text-gray-800">Organic</span><span class="text-gray-500 text-xs">65%</span></div>
                <div><span class="block font-bold text-gray-800">Social</span><span class="text-gray-500 text-xs">25%</span></div>
                <div><span class="block font-bold text-gray-800">Direct</span><span class="text-gray-500 text-xs">10%</span></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-sm shadow-sm border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-6">Top Content</h3>
            <div class="space-y-5">
                ${articles.sort((a,b)=>b.views-a.views).slice(0, 5).map(a => `
                <div>
                    <div class="flex justify-between text-xs font-medium mb-1">
                        <span class="truncate w-3/4">${a.title}</span>
                        <span class="text-gray-500">${a.views}</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5">
                        <div class="bg-brand-copper h-1.5 rounded-full" style="width: ${Math.min((a.views/5000)*100, 100)}%"></div>
                    </div>
                </div>`).join('')}
            </div>
        </div>
    </div>`;
}

// --- VIEW: LISTS ---
function renderContentList(type) {
    const items = articles.filter(a => (a.type || 'article') === type);
    const title = type === 'article' ? 'Articles' : 'Pages';
    
    return `
    <div class="flex justify-between mb-6">
        <h3 class="font-bold text-lg">${title} Management</h3>
        <button onclick="createNew('${type}')" class="bg-brand-copper text-white px-5 py-2 rounded-sm font-bold uppercase text-xs tracking-wider flex items-center hover:bg-orange-700 transition">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> New ${title}
        </button>
    </div>
    <div class="bg-white rounded-sm shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b border-gray-200">
                <tr>
                    <th class="p-4">Title</th>
                    <th class="p-4">Status</th>
                    ${type === 'article' ? '<th class="p-4">Category</th>' : ''}
                    <th class="p-4">Date</th>
                    <th class="p-4 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 text-sm">
                ${items.map(a => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-4 font-medium text-gray-900">
                        ${a.title}
                        ${a.featured ? '<span class="ml-2 text-[10px] bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded font-bold uppercase">Top Story</span>' : ''}
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide 
                            ${a.status === 'published' ? 'bg-green-100 text-green-700' : 
                              a.status === 'scheduled' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">
                            ${a.status || 'Draft'}
                        </span>
                    </td>
                    ${type === 'article' ? `<td class="p-4 text-gray-600">${a.category}</td>` : ''}
                    <td class="p-4 text-gray-600">${a.publishedAt ? new Date(a.publishedAt).toLocaleDateString() : '-'}</td>
                    <td class="p-4 text-right space-x-2">
                        <button onclick="editContent('${a.id}')" class="text-gray-400 hover:text-brand-copper"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deleteContent('${a.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('')}
                ${items.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-gray-400">No items found.</td></tr>' : ''}
            </tbody>
        </table>
    </div>`;
}

// --- VIEW: ADVANCED EDITOR ---
function renderEditor() {
    const a = appState.editingItem || { title: '', content: '', status: 'draft', type: 'article' };
    const isPage = a.type === 'page';

    return `
    <div class="flex flex-col lg:flex-row gap-6 h-full pb-20">
        <!-- Main Content Area -->
        <div class="flex-grow bg-white rounded-sm shadow-sm border border-gray-200 flex flex-col min-h-[600px]">
            <div class="p-6 border-b border-gray-100">
                <input type="text" id="editor-title" value="${a.title || ''}" placeholder="Enter Title Here..." class="w-full text-3xl font-bold font-display placeholder-gray-300 border-none outline-none">
            </div>
            
            <div class="flex items-center gap-1 p-2 bg-gray-50 border-b border-gray-200 flex-wrap sticky top-0 z-20">
                <button onclick="execCmd('bold')" class="p-2 hover:bg-gray-200 rounded" title="Bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                <button onclick="execCmd('italic')" class="p-2 hover:bg-gray-200 rounded" title="Italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                <div class="w-px h-6 bg-gray-300 mx-1"></div>
                <button onclick="execCmd('formatBlock', 'H2')" class="p-2 hover:bg-gray-200 rounded text-xs font-bold">H2</button>
                <button onclick="execCmd('formatBlock', 'H3')" class="p-2 hover:bg-gray-200 rounded text-xs font-bold">H3</button>
                <button onclick="execCmd('formatBlock', 'P')" class="p-2 hover:bg-gray-200 rounded text-xs font-bold">P</button>
                <button onclick="execCmd('formatBlock', 'BLOCKQUOTE')" class="p-2 hover:bg-gray-200 rounded text-xs font-bold">Quote</button>
                <div class="w-px h-6 bg-gray-300 mx-1"></div>
                <button onclick="execCmd('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded"><i data-lucide="list" class="w-4 h-4"></i></button>
                <div class="w-px h-6 bg-gray-300 mx-1"></div>
                <label class="p-2 hover:bg-gray-200 rounded cursor-pointer" title="Upload Image from Computer">
                    <i data-lucide="image-plus" class="w-4 h-4"></i>
                    <input type="file" class="hidden" accept="image/*" onchange="insertImage(this)">
                </label>
            </div>
            
            <div id="editor-content" contenteditable="true" class="flex-grow p-8 outline-none prose max-w-none overflow-y-auto" placeholder="Start writing your story...">${a.content || ''}</div>
        </div>

        <!-- Sidebar -->
        <div class="w-full lg:w-80 space-y-4">
            
            <div class="bg-white p-4 rounded-sm shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold uppercase text-gray-400">Status</h3>
                    <span class="text-xs font-bold ${a.status==='published'?'text-green-600':a.status==='scheduled'?'text-blue-600':'text-orange-500'} uppercase">${a.status || 'Draft'}</span>
                </div>
                <div class="space-y-3">
                     <button onclick="saveContent('published')" class="w-full bg-green-600 text-white py-2 rounded-sm font-bold uppercase text-xs hover:bg-green-700 transition">Publish Now</button>
                     <button onclick="saveContent('draft')" class="w-full bg-gray-100 text-gray-600 py-2 rounded-sm font-bold uppercase text-xs hover:bg-gray-200 transition">Save Draft</button>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Schedule Publish</label>
                    <input type="datetime-local" id="editor-schedule" class="w-full text-xs border border-gray-300 rounded-sm p-2" value="${(a.publishedAt && a.status === 'scheduled') ? a.publishedAt.slice(0,16) : ''}">
                </div>
            </div>

            <div class="bg-white p-4 rounded-sm shadow-sm border border-gray-200 space-y-4">
                <h3 class="text-xs font-bold uppercase text-gray-400 border-b pb-2">Settings</h3>
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-2">Featured Image</label>
                    <div id="featured-image-preview" class="w-full aspect-video bg-gray-100 rounded-sm mb-2 flex items-center justify-center text-gray-400 text-xs">
                        ${a.imageUrl ? `<img src="${a.imageUrl}" class="w-full h-full object-cover rounded-sm">` : '<span>No Image</span>'}
                    </div>
                    <label class="cursor-pointer text-xs text-brand-copper font-bold hover:underline">
                        Upload Image
                        <input type="file" class="hidden" accept="image/*" onchange="updateFeaturedImage(this)">
                    </label>
                </div>
                ${!isPage ? `
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-1">Category</label>
                    <select id="editor-category" class="w-full border border-gray-300 rounded-sm p-2 text-sm bg-white">
                        ${categories.map(c => `<option value="${c}" ${a.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-1">Author</label>
                    <select id="editor-author" class="w-full border border-gray-300 rounded-sm p-2 text-sm bg-white">
                         ${users.map(u => `<option value="${u.name}" ${a.author === u.name ? 'selected' : ''}>${u.name}</option>`).join('')}
                         <option value="Redaktion" ${a.author === 'Redaktion' ? 'selected' : ''}>Redaktion</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-1">Tags (comma separated)</label>
                    <input type="text" id="editor-tags" value="${(a.tags || []).join(', ')}" class="w-full border border-gray-300 rounded-sm p-2 text-sm" placeholder="Heizung, Markt...">
                </div>
                 <div class="flex items-center pt-2">
                    <input type="checkbox" id="editor-featured" ${a.featured ? 'checked' : ''} class="mr-2 accent-brand-copper">
                    <label for="editor-featured" class="text-sm text-gray-700">Set as Top Story</label>
                </div>
                ` : ''}
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-1">Excerpt</label>
                    <textarea id="editor-summary" rows="3" class="w-full border border-gray-300 rounded-sm p-2 text-sm text-gray-600">${a.summary || ''}</textarea>
                </div>
            </div>

            <div class="bg-white p-4 rounded-sm shadow-sm border border-gray-200 space-y-4">
                <h3 class="text-xs font-bold uppercase text-gray-400 border-b pb-2">SEO</h3>
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-1">Custom Slug</label>
                    <input type="text" id="editor-slug" value="${a.slug || ''}" class="w-full border border-gray-300 rounded-sm p-2 text-sm bg-gray-50 font-mono text-xs" placeholder="my-custom-url">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-1">Meta Title</label>
                    <input type="text" id="editor-meta-title" value="${a.metaTitle || ''}" class="w-full border border-gray-300 rounded-sm p-2 text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600 block mb-1">Meta Description</label>
                    <textarea id="editor-meta-desc" rows="2" class="w-full border border-gray-300 rounded-sm p-2 text-sm">${a.metaDescription || ''}</textarea>
                </div>
            </div>

            <div class="bg-white p-4 rounded-sm shadow-sm border border-gray-200 space-y-4">
                 <button onclick="alert('Sent to Newsletter API (Mock)')" class="w-full border border-gray-300 text-gray-600 py-2 rounded-sm font-bold uppercase text-[10px] hover:bg-gray-50 flex items-center justify-center">
                    <i data-lucide="mail" class="w-3 h-3 mr-2"></i> Push to Newsletter
                 </button>
                 <div class="pt-4 border-t border-gray-100">
                    <h3 class="text-xs font-bold uppercase text-gray-400 mb-2">Revision History</h3>
                    <ul class="space-y-2 text-xs text-gray-500">
                        ${(a.revisions || []).slice(0,3).map(r => `
                            <li class="flex justify-between">
                                <span>${new Date(r.date).toLocaleDateString()}</span>
                                <span class="text-gray-400">${r.user}</span>
                            </li>
                        `).join('')}
                        ${!(a.revisions?.length) ? '<li>No revisions yet</li>' : ''}
                    </ul>
                 </div>
            </div>
        </div>
    </div>`;
}

// --- VIEW: MEDIA LIBRARY ---
function renderMediaLibrary() {
    return `
    <div class="flex justify-between mb-6">
        <h3 class="font-bold text-lg">Central Media Library</h3>
        <label class="bg-brand-copper text-white px-5 py-2 rounded-sm font-bold uppercase text-xs tracking-wider flex items-center hover:bg-orange-700 transition cursor-pointer">
            <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Upload Image
            <input type="file" class="hidden" accept="image/*" onchange="uploadMedia(this)">
        </label>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        ${mediaLibrary.map(m => `
        <div class="group relative bg-white rounded-sm shadow-sm border border-gray-200 aspect-square overflow-hidden">
            <img src="${m.url}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center space-y-2">
                <button onclick="copyToClipboard('${m.url}')" class="text-white text-xs font-bold hover:text-brand-copper flex items-center"><i data-lucide="copy" class="w-4 h-4 mr-1"></i> Copy URL</button>
                <button onclick="deleteMedia('${m.id}')" class="text-white text-xs font-bold hover:text-red-500 flex items-center"><i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Delete</button>
            </div>
        </div>`).join('')}
    </div>`;
}

// --- VIEW: USERS ---
function renderUsers() {
    return `
    <div class="flex justify-between mb-6">
        <h3 class="font-bold text-lg">User Management</h3>
        <button onclick="openModal('user')" class="bg-brand-copper text-white px-5 py-2 rounded-sm font-bold uppercase text-xs tracking-wider flex items-center hover:bg-orange-700 transition">
            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i> Add User
        </button>
    </div>
    <div class="bg-white rounded-sm shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b border-gray-200">
                <tr><th>User</th><th>Role</th><th>Email</th><th class="text-right">Action</th></tr>
            </thead>
            <tbody class="divide-y divide-gray-100 text-sm">
                ${users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 flex items-center">
                        <img src="${u.avatar}" class="w-8 h-8 rounded-full mr-3">
                        <span class="font-medium">${u.name}</span>
                    </td>
                    <td class="p-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold">${u.role}</span></td>
                    <td class="p-4 text-gray-500">${u.email}</td>
                    <td class="p-4 text-right">
                        <button onclick="deleteUser('${u.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    </div>`;
}

// --- VIEW: CATEGORIES ---
function renderCategories() {
    return `
    <div class="max-w-3xl">
        <h3 class="font-bold text-lg mb-6">Manage Categories</h3>
        <div class="bg-white p-6 rounded-sm shadow-sm border border-gray-200 mb-6 flex gap-2">
            <input type="text" id="new-cat-input" placeholder="New Category Name" class="flex-grow border border-gray-300 p-2 rounded-sm focus:border-brand-copper outline-none">
            <button onclick="addCategory()" class="bg-brand-dark text-white px-4 py-2 rounded-sm font-bold uppercase text-xs">Add</button>
        </div>
        <div class="bg-white rounded-sm shadow-sm border border-gray-200 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b border-gray-200">
                    <tr><th class="p-4">Name</th><th class="p-4 text-right">Action</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-100 text-sm">
                    ${categories.map(c => `
                    <tr>
                        <td class="p-4 font-medium">${c}</td>
                        <td class="p-4 text-right">
                            <button onclick="deleteCategory('${c}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
}

// --- VIEW: DIRECTORY ---
function renderDirectory() {
    return `
    <div class="flex justify-between mb-6">
        <h3 class="font-bold text-lg">Business Directory</h3>
        <button onclick="openModal('business')" class="bg-brand-copper text-white px-5 py-2 rounded-sm font-bold uppercase text-xs tracking-wider flex items-center hover:bg-orange-700 transition">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Company
        </button>
    </div>
    <div class="bg-white rounded-sm shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase border-b border-gray-200">
                <tr><th>Name</th><th>Category</th><th>City</th><th class="text-right">Action</th></tr>
            </thead>
            <tbody class="divide-y divide-gray-100 text-sm">
                ${directory.map(b => `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-medium">${b.name}</td>
                    <td class="p-4">${b.category}</td>
                    <td class="p-4">${b.city}</td>
                    <td class="p-4 text-right">
                        <button onclick="editBusiness('${b.id}')" class="text-gray-400 hover:text-brand-copper p-1"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deleteBusiness('${b.id}')" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    </div>`;
}

// --- VIEW: SETTINGS ---
function renderSettings() {
    return `
    <div class="max-w-2xl bg-white p-8 rounded-sm shadow-sm border border-gray-200">
        <h3 class="text-lg font-bold mb-6 border-b pb-4">Configuration</h3>
        
        <div class="space-y-6">
            <div>
                <h4 class="text-sm font-bold uppercase text-gray-500 mb-2">Sync Engine</h4>
                <p class="text-xs text-gray-400 mb-2">Connect to your Google Apps Script Backend.</p>
                <input type="text" id="settings-url" value="${settings.articlesScriptUrl || ''}" placeholder="https://script.google.com/..." class="w-full border border-gray-300 p-2 rounded-sm text-sm">
            </div>

            <div>
                <h4 class="text-sm font-bold uppercase text-gray-500 mb-2">Integrations</h4>
                <div class="grid gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Google Analytics Measurement ID</label>
                        <input type="text" id="settings-ga" value="${settings.gaMeasurementId || ''}" placeholder="G-XXXXXXXXXX" class="w-full border border-gray-300 p-2 rounded-sm text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Newsletter API Key (Mailchimp)</label>
                        <input type="password" id="settings-news" value="${settings.newsletterApiKey || ''}" class="w-full border border-gray-300 p-2 rounded-sm text-sm">
                    </div>
                </div>
            </div>

            <div class="flex items-center space-x-4 pt-6 border-t">
                <button onclick="saveSettings()" class="bg-brand-dark text-white px-6 py-2 rounded-sm font-bold uppercase text-xs">Save Settings</button>
                <button onclick="triggerSync()" id="sync-btn" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-sm font-bold uppercase text-xs hover:bg-gray-50 flex items-center">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2 ${appState.syncState === 'loading' ? 'animate-spin' : ''}"></i> 
                    ${appState.syncState === 'loading' ? 'Syncing...' : 'Sync Now'}
                </button>
            </div>
            ${appState.syncState === 'success' ? '<p class="text-green-600 text-xs font-bold mt-2">Sync Completed Successfully.</p>' : ''}
            ${appState.syncState === 'error' ? '<p class="text-red-500 text-xs font-bold mt-2">Sync Failed. Check URL.</p>' : ''}
        </div>
    </div>`;
}

// --- MODAL ---
function renderModal() {
    let content = '';
    
    if (appState.modalType === 'business') {
        const b = appState.editingItem || {};
        content = `
        <h3 class="font-bold text-lg mb-4">${b.id ? 'Edit' : 'Add'} Company</h3>
        <div class="space-y-4">
            <input id="modal-biz-name" value="${b.name || ''}" placeholder="Company Name" class="w-full border p-2 rounded-sm">
            <input id="modal-biz-city" value="${b.city || ''}" placeholder="City" class="w-full border p-2 rounded-sm">
            <select id="modal-biz-cat" class="w-full border p-2 rounded-sm bg-white">
                ${['Heizung','Sanitär','Klima','Lüftung','Elektro'].map(c => `<option value="${c}" ${b.category===c?'selected':''}>${c}</option>`).join('')}
            </select>
            <textarea id="modal-biz-desc" placeholder="Description" class="w-full border p-2 rounded-sm" rows="3">${b.description || ''}</textarea>
        </div>
        <div class="flex justify-end mt-6 space-x-2">
            <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:text-gray-800">Cancel</button>
            <button onclick="saveBusiness()" class="bg-brand-copper text-white px-4 py-2 rounded-sm font-bold">Save</button>
        </div>`;
    } else if (appState.modalType === 'user') {
        content = `
        <h3 class="font-bold text-lg mb-4">Add User</h3>
        <div class="space-y-4">
            <input id="modal-user-name" placeholder="Full Name" class="w-full border p-2 rounded-sm">
            <input id="modal-user-email" placeholder="Email" class="w-full border p-2 rounded-sm">
            <select id="modal-user-role" class="w-full border p-2 rounded-sm bg-white">
                <option value="Contributor">Contributor</option>
                <option value="Editor">Editor</option>
                <option value="Administrator">Administrator</option>
            </select>
        </div>
        <div class="flex justify-end mt-6 space-x-2">
            <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:text-gray-800">Cancel</button>
            <button onclick="saveUser()" class="bg-brand-copper text-white px-4 py-2 rounded-sm font-bold">Create</button>
        </div>`;
    }

    return `
    <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-sm shadow-xl p-6">
            ${content}
        </div>
    </div>`;
}

// --- 4. CONTROLLER / ACTIONS ---

function navigate(view) {
    appState.activeView = view;
    render();
}

function logout() {
    sessionStorage.removeItem('shk_auth_user');
    render();
}

function attachLoginListeners() {
    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const userJson = document.getElementById('login-user-select').value;
        sessionStorage.setItem('shk_auth_user', userJson);
        render();
    });
}

function createNew(type) {
    appState.editingItem = { 
        type, title: '', content: '<p>Start writing...</p>', status: 'draft', 
        category: type === 'article' ? categories[0] : 'Page',
        tags: [],
        author: appState.currentUser.name,
        revisions: []
    };
    appState.activeView = 'editor';
    render();
}

function editContent(id) {
    appState.editingItem = { ...articles.find(a => a.id === id) };
    appState.activeView = 'editor';
    render();
}

function deleteContent(id) {
    if(confirm('Delete this item?')) {
        articles = articles.filter(a => a.id !== id);
        saveData();
        render();
    }
}

function saveContent(status) {
    const item = appState.editingItem;
    item.title = document.getElementById('editor-title').value;
    item.content = document.getElementById('editor-content').innerHTML;
    
    const scheduledDate = document.getElementById('editor-schedule') ? document.getElementById('editor-schedule').value : null;
    if (scheduledDate) {
        item.status = 'scheduled';
        item.publishedAt = new Date(scheduledDate).toISOString();
    } else {
        item.status = status;
        if (status === 'published' && item.status !== 'published') {
            item.publishedAt = new Date().toISOString();
        }
    }

    if(item.type === 'article') {
        item.category = document.getElementById('editor-category').value;
        item.author = document.getElementById('editor-author').value;
        item.featured = document.getElementById('editor-featured').checked;
        item.summary = document.getElementById('editor-summary').value;
        item.slug = document.getElementById('editor-slug').value;
        item.metaTitle = document.getElementById('editor-meta-title').value;
        item.metaDescription = document.getElementById('editor-meta-desc').value;
        
        const tagStr = document.getElementById('editor-tags').value;
        item.tags = tagStr ? tagStr.split(',').map(t=>t.trim()) : [];
        
        if (!item.revisions) item.revisions = [];
        item.revisions.unshift({ date: new Date().toISOString(), user: appState.currentUser.name, note: 'Updated' });
    }

    if (!item.title) return alert('Title is required');
    if (!item.id) item.id = 'art-' + Date.now();

    const idx = articles.findIndex(a => a.id === item.id);
    if (idx >= 0) articles[idx] = item;
    else articles.unshift(item);

    saveData();
    appState.activeView = item.type === 'article' ? 'articles' : 'pages';
    render();
}

// Editor Utilities
function execCmd(cmd, val) { document.execCommand(cmd, false, val); }

function saveSelection() {
    if (window.getSelection) {
        const sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            savedRange = sel.getRangeAt(0);
        }
    }
}

function insertImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const editor = document.getElementById('editor-content');
            editor.focus();
            if (savedRange) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.borderRadius = '4px';
                
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);

                savedRange.deleteContents();
                savedRange.insertNode(img);
            } else { // Fallback
                 document.execCommand('insertImage', false, e.target.result);
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function updateFeaturedImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            appState.editingItem.imageUrl = e.target.result;
            document.getElementById('featured-image-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-sm">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function attachEditorEventListeners() {
    const editorDiv = document.getElementById('editor-content');
    if (editorDiv) {
        editorDiv.addEventListener('keyup', saveSelection);
        editorDiv.addEventListener('mouseup', saveSelection);
        editorDiv.addEventListener('focus', saveSelection);
    }
}

// Media Library
function uploadMedia(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            mediaLibrary.unshift({
                id: 'media-' + Date.now(),
                url: e.target.result,
                name: input.files[0].name,
                date: new Date().toISOString()
            });
            saveData();
            render();
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function deleteMedia(id) {
    if(confirm('Delete image?')) {
        mediaLibrary = mediaLibrary.filter(m => m.id !== id);
        saveData();
        render();
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert('URL Copied!'));
}

// Categories
function addCategory() {
    const val = document.getElementById('new-cat-input').value;
    if(val && !categories.includes(val)) {
        categories.push(val);
        saveData();
        render();
    }
}

function deleteCategory(cat) {
    if(confirm('Delete category?')) {
        categories = categories.filter(c => c !== cat);
        saveData();
        render();
    }
}

// Directory / Users Modals
function openModal(type) {
    appState.modalType = type;
    appState.editingItem = type === 'business' ? {} : null;
    appState.modalOpen = true;
    render();
}

function closeModal() { appState.modalOpen = false; render(); }

function editBusiness(id) {
    appState.editingItem = { ...directory.find(d => d.id === id) };
    appState.modalType = 'business';
    appState.modalOpen = true;
    render();
}

function saveBusiness() {
    const item = appState.editingItem;
    item.name = document.getElementById('modal-biz-name').value;
    item.city = document.getElementById('modal-biz-city').value;
    item.category = document.getElementById('modal-biz-cat').value;
    item.description = document.getElementById('modal-biz-desc').value;
    item.logoUrl = item.logoUrl || 'https://via.placeholder.com/100';

    if(!item.name) return alert('Name required');
    if(!item.id) item.id = 'dir-' + Date.now();

    const idx = directory.findIndex(d => d.id === item.id);
    if (idx >= 0) directory[idx] = item;
    else directory.unshift(item);

    saveData();
    closeModal();
}

function saveUser() {
    const u = {
        id: 'user-' + Date.now(),
        name: document.getElementById('modal-user-name').value,
        email: document.getElementById('modal-user-email').value,
        role: document.getElementById('modal-user-role').value,
        avatar: `https://ui-avatars.com/api/?name=${document.getElementById('modal-user-name').value}`
    };
    if(!u.name) return alert('Name required');
    users.push(u);
    saveData();
    closeModal();
}

function deleteUser(id) {
    if(confirm('Delete user?')) {
        users = users.filter(u => u.id !== id);
        saveData();
        render();
    }
}

// Settings & Sync
function saveSettings() {
    settings.articlesScriptUrl = document.getElementById('settings-url').value;
    settings.gaMeasurementId = document.getElementById('settings-ga').value;
    settings.newsletterApiKey = document.getElementById('settings-news').value;
    saveData();
    alert('Settings Saved');
}

async function triggerSync() {
    if (!settings.articlesScriptUrl) return alert('Please enter Apps Script URL');
    appState.syncState = 'loading';
    render();

    try {
        const response = await fetch(settings.articlesScriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'sync', articles, directory, categories, users, mediaLibrary }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            mode: 'no-cors' 
        });
        
        setTimeout(() => {
            appState.syncState = 'success';
            localStorage.removeItem('shk_data_cache_timestamp'); // Invalidate public cache
            localStorage.setItem('shk_cms_synced', Date.now()); // Signal other tabs to reload
            render();
            setTimeout(() => { appState.syncState = 'idle'; render(); }, 3000);
        }, 1500);

    } catch (e) {
        console.error('Sync Error:', e);
        appState.syncState = 'error';
        render();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadData();
    render();
});

</script>
</body>
</html>