<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS | SHK Rhein-Neckar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        .editor-content:empty:before { content: attr(placeholder); color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900">

<div id="root" class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col">
        <div class="p-6 border-b border-slate-800">
            <h1 class="font-bold text-lg tracking-wider">SHK ADMIN</h1>
        </div>
        <nav class="flex-grow p-4 space-y-2">
            <button onclick="nav('dashboard')" class="w-full text-left px-4 py-2 rounded hover:bg-white/10 flex items-center"><i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i> Dashboard</button>
            <button onclick="nav('articles')" class="w-full text-left px-4 py-2 rounded hover:bg-white/10 flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-3"></i> Articles</button>
            <button onclick="nav('directory')" class="w-full text-left px-4 py-2 rounded hover:bg-white/10 flex items-center"><i data-lucide="building" class="w-4 h-4 mr-3"></i> Directory</button>
            <button onclick="nav('settings')" class="w-full text-left px-4 py-2 rounded hover:bg-white/10 flex items-center"><i data-lucide="settings" class="w-4 h-4 mr-3"></i> Settings</button>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <button onclick="location.href='index.html'" class="w-full text-center text-xs uppercase font-bold text-gray-400 hover:text-white">Back to Site</button>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto" id="main-view">
        <!-- Content injected via JS -->
    </main>
</div>

<script>
// --- CONFIG ---
const DEFAULT_API = 'https://script.google.com/macros/s/AKfycbxw9Sw74S1Yy5W0zVCRHZ7ZxTTOISUKZzk793WkeR8TW9eF61Mws4aGcOPRg1JaiUBuPQ/exec';

// --- STATE ---
let articles = JSON.parse(localStorage.getItem('shk_articles')) || [];
let directory = JSON.parse(localStorage.getItem('shk_directory')) || [];
let settings = JSON.parse(localStorage.getItem('shk_settings')) || { apiUrl: DEFAULT_API };
let activeView = 'dashboard';
let editingId = null;

// --- INIT ---
function init() {
    if (articles.length === 0) seedData();
    render();
}

function seedData() {
    articles = [
        { id: '1', title: 'Start Your First Article', category: 'General', author: 'Admin', status: 'published', publishedAt: new Date().toISOString(), summary: 'Welcome to your new CMS.', content: '<h2>Hello World</h2><p>This is your first article. Edit it or sync it to Google Docs.</p>', featured: true, imageUrl: 'https://images.unsplash.com/photo-1581092334651-ddf26d9a09d0' }
    ];
    directory = [
        { id: 'd1', name: 'Sample Business', category: 'Heizung', city: 'Mannheim', phone: '12345', description: 'A sample entry.', logoUrl: '' }
    ];
    save();
}

function save() {
    localStorage.setItem('shk_articles', JSON.stringify(articles));
    localStorage.setItem('shk_directory', JSON.stringify(directory));
    localStorage.setItem('shk_settings', JSON.stringify(settings));
}

function nav(view) {
    activeView = view;
    editingId = null;
    render();
}

// --- RENDER ---
function render() {
    const main = document.getElementById('main-view');
    lucide.createIcons();
    
    if (activeView === 'dashboard') {
        main.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
            <div class="grid grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded shadow"><h3 class="text-gray-500 text-xs uppercase font-bold">Total Articles</h3><p class="text-4xl font-black text-slate-900">${articles.length}</p></div>
                <div class="bg-white p-6 rounded shadow"><h3 class="text-gray-500 text-xs uppercase font-bold">Directory Entries</h3><p class="text-4xl font-black text-slate-900">${directory.length}</p></div>
                <div class="bg-white p-6 rounded shadow cursor-pointer hover:bg-blue-50" onclick="triggerSync()"><h3 class="text-blue-500 text-xs uppercase font-bold">Sync Status</h3><p class="text-xl font-bold text-blue-900 mt-2">Sync Now &rarr;</p></div>
            </div>
        `;
    } else if (activeView === 'articles') {
        if (editingId) {
            const art = articles.find(a => a.id === editingId) || { id: Date.now().toString(), title: '', content: '' };
            main.innerHTML = `
                <div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Edit Article</h2><button onclick="saveArticle()" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Save</button></div>
                <div class="bg-white p-6 rounded shadow space-y-4">
                    <input id="edit-title" value="${art.title}" class="w-full text-2xl font-bold border-b p-2 outline-none" placeholder="Article Title" />
                    <input id="edit-img" value="${art.imageUrl || ''}" class="w-full text-sm border p-2 rounded" placeholder="Image URL (Unsplash...)" />
                    <div class="grid grid-cols-2 gap-4">
                        <select id="edit-cat" class="border p-2 rounded"><option>Branchen-News</option><option>Technologie</option><option>Regional</option></select>
                        <select id="edit-status" class="border p-2 rounded"><option value="published">Published</option><option value="draft">Draft</option></select>
                    </div>
                    <textarea id="edit-summary" class="w-full border p-2 rounded h-20" placeholder="Summary">${art.summary || ''}</textarea>
                    
                    <!-- Simple Rich Text -->
                    <div class="border rounded">
                        <div class="bg-gray-50 border-b p-2 flex space-x-2">
                            <button onclick="document.execCommand('bold')" class="font-bold px-2">B</button>
                            <button onclick="document.execCommand('italic')" class="italic px-2">I</button>
                            <button onclick="document.execCommand('formatBlock', false, 'h2')" class="font-bold px-2">H2</button>
                        </div>
                        <div id="edit-content" contenteditable="true" class="p-4 h-96 outline-none prose max-w-none">${art.content || ''}</div>
                    </div>
                </div>
            `;
            document.getElementById('edit-cat').value = art.category || 'Branchen-News';
            document.getElementById('edit-status').value = art.status || 'draft';
        } else {
            main.innerHTML = `
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Articles</h2><button onclick="createArticle()" class="bg-blue-600 text-white px-4 py-2 rounded">New Article</button></div>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b"><tr><th class="p-4">Title</th><th class="p-4">Category</th><th class="p-4">Actions</th></tr></thead>
                        <tbody>
                            ${articles.map(a => `<tr class="border-b hover:bg-gray-50">
                                <td class="p-4 font-bold">${a.title}</td>
                                <td class="p-4 text-sm">${a.category}</td>
                                <td class="p-4"><button onclick="editArticle('${a.id}')" class="text-blue-600 font-bold mr-2">Edit</button><button onclick="deleteArticle('${a.id}')" class="text-red-600">Delete</button></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    } else if (activeView === 'directory') {
        if (editingId) {
             const biz = directory.find(d => d.id === editingId) || { id: Date.now().toString() };
             main.innerHTML = `
                <div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Edit Business</h2><button onclick="saveBusiness()" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Save</button></div>
                <div class="bg-white p-6 rounded shadow space-y-4 max-w-xl">
                    <input id="biz-name" value="${biz.name||''}" class="w-full border p-2 rounded" placeholder="Company Name" />
                    <input id="biz-cat" value="${biz.category||''}" class="w-full border p-2 rounded" placeholder="Category (Heizung, SanitÃ¤r...)" />
                    <input id="biz-city" value="${biz.city||''}" class="w-full border p-2 rounded" placeholder="City" />
                    <input id="biz-phone" value="${biz.phone||''}" class="w-full border p-2 rounded" placeholder="Phone" />
                    <textarea id="biz-desc" class="w-full border p-2 rounded" placeholder="Description">${biz.description||''}</textarea>
                </div>
             `;
        } else {
             main.innerHTML = `
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Directory</h2><button onclick="createBusiness()" class="bg-blue-600 text-white px-4 py-2 rounded">New Entry</button></div>
                <div class="bg-white rounded shadow">
                    ${directory.map(d => `<div class="p-4 border-b flex justify-between items-center"><div><div class="font-bold">${d.name}</div><div class="text-sm text-gray-500">${d.category} - ${d.city}</div></div><div><button onclick="editBusiness('${d.id}')" class="text-blue-600 mr-2">Edit</button><button onclick="deleteBusiness('${d.id}')" class="text-red-600">Delete</button></div></div>`).join('')}
                </div>
             `;
        }
    } else if (activeView === 'settings') {
        main.innerHTML = `
            <div class="max-w-xl bg-white p-8 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Connection Settings</h2>
                <label class="block text-sm font-bold mb-2">Google Apps Script URL</label>
                <input id="set-api" class="w-full border p-2 rounded mb-4" value="${settings.apiUrl}" />
                <button onclick="saveSettingsLocal()" class="bg-slate-900 text-white px-4 py-2 rounded">Save URL</button>
                <hr class="my-6" />
                <h3 class="font-bold mb-2">Sync Data</h3>
                <p class="text-sm text-gray-500 mb-4">Push your local changes to Google Drive/Sheets.</p>
                <button onclick="triggerSync()" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Sync Now</button>
            </div>
        `;
    }
}

// --- ACTIONS ---
function createArticle() { editingId = 'new'; render(); }
function editArticle(id) { editingId = id; render(); }
function deleteArticle(id) { articles = articles.filter(a => a.id !== id); save(); render(); }
function saveArticle() {
    const id = editingId === 'new' ? Date.now().toString() : editingId;
    const newItem = {
        id,
        title: document.getElementById('edit-title').value,
        imageUrl: document.getElementById('edit-img').value,
        category: document.getElementById('edit-cat').value,
        status: document.getElementById('edit-status').value,
        summary: document.getElementById('edit-summary').value,
        content: document.getElementById('edit-content').innerHTML,
        publishedAt: new Date().toISOString(),
        featured: false, author: 'Admin'
    };
    if (editingId === 'new') articles.unshift(newItem);
    else { const idx = articles.findIndex(a => a.id === id); articles[idx] = newItem; }
    editingId = null; save(); render();
}

function createBusiness() { editingId = 'new'; render(); }
function editBusiness(id) { editingId = id; render(); }
function deleteBusiness(id) { directory = directory.filter(d => d.id !== id); save(); render(); }
function saveBusiness() {
    const id = editingId === 'new' ? Date.now().toString() : editingId;
    const newItem = {
        id,
        name: document.getElementById('biz-name').value,
        category: document.getElementById('biz-cat').value,
        city: document.getElementById('biz-city').value,
        phone: document.getElementById('biz-phone').value,
        description: document.getElementById('biz-desc').value,
        logoUrl: 'https://via.placeholder.com/100'
    };
    if (editingId === 'new') directory.unshift(newItem);
    else { const idx = directory.findIndex(d => d.id === id); directory[idx] = newItem; }
    editingId = null; save(); render();
}

function saveSettingsLocal() {
    settings.apiUrl = document.getElementById('set-api').value;
    save(); alert('Settings Saved');
}

async function triggerSync() {
    const btn = document.querySelector('button[onclick="triggerSync()"]');
    if(btn) btn.innerText = "Syncing...";
    
    try {
        await fetch(settings.apiUrl, {
            method: 'POST',
            mode: 'no-cors', // Important for Apps Script
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'sync',
                articles: articles,
                directory: directory
            })
        });
        alert('Sync data sent to Google!');
    } catch(e) {
        console.error(e);
        alert('Sync failed. Check console.');
    } finally {
        if(btn) btn.innerText = "Sync Now";
    }
}

// Start
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>