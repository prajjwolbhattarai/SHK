<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS | SHK Rhein-Neckar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Montserrat', 'sans-serif'] },
            colors: { 'brand-dark': '#0f172a', 'brand-copper': '#b45309' }
          }
        }
      }
    </script>
    <style>.no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }</style>
</head>
<body class="bg-gray-100 font-sans text-brand-dark">
    <div id="app-root"></div>
<script>
// --- V A N I L L A   J S   C M S ---

// Store
let articles=[], directory=[], categories=[], users=[], mediaLibrary=[];
let settings={articlesScriptUrl:'', directoryScriptUrl:'', gaMeasurementId:''};

const appState = {
    currentUser: null,
    activeView: 'dashboard',
    modalOpen: false, modalType: null, editingItem: null,
    syncStateArticles: 'idle', syncStateDirectory: 'idle'
};

function loadData() {
    const ls = k => localStorage.getItem(k) ? JSON.parse(localStorage.getItem(k)) : null;
    articles = ls('shk_articles') || [];
    directory = ls('shk_directory') || [];
    categories = ls('shk_categories') || ['Branchen-News', 'Betriebs-Features', 'Personal & Karriere', 'Technologie', 'Energie & Nachhaltigkeit', 'Regional'];
    settings = ls('shk_settings') || { articlesScriptUrl:'', directoryScriptUrl:'' };
    users = ls('shk_users') || [];
    mediaLibrary = ls('shk_media') || [];

    if (articles.length === 0 || directory.length === 0) seedMockData();
    if (users.length === 0) seedUsers();
}

function saveData() {
    localStorage.setItem('shk_articles', JSON.stringify(articles));
    localStorage.setItem('shk_directory', JSON.stringify(directory));
    localStorage.setItem('shk_categories', JSON.stringify(categories));
    localStorage.setItem('shk_settings', JSON.stringify(settings));
    localStorage.setItem('shk_users', JSON.stringify(users));
    localStorage.setItem('shk_media', JSON.stringify(mediaLibrary));
    // Trigger storage event for other tabs
    window.dispatchEvent(new Event('storage'));
}

function seedMockData() {
    articles = [
        {id:"art-1",type:"article",title:"Neue Energieverordnungen 2025: Was gilt ab Januar?",summary:"Ein umfassender Bericht über Neue Energieverordnungen 2025.",imageUrl:"https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Redaktion",publishedAt:"2025-10-25T10:00:00.000Z",featured:true,status:'published',views:1240},
        {id:"art-2",type:"article",title:"Rückblick ISH Messe Frankfurt: Die Highlights",summary:"Die wichtigsten Trends der Weltleitmesse.",imageUrl:"https://images.unsplash.com/photo-1542744173-8e7e53415bb0?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Markus Weber",publishedAt:"2025-10-24T10:00:00.000Z",featured:false,status:'published',views:890},
        {id:"art-3",type:"article",title:"Großhandelspreise stabilisieren sich",summary:"Entwarnung für Handwerksbetriebe.",imageUrl:"https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&q=80&w=1200",category:"Branchen-News",author:"Julia Schmidt",publishedAt:"2025-10-23T10:00:00.000Z",featured:false,status:'published',views:560},
        {id:"art-4",type:"article",title:"Digitalisierung im Handwerk: Eine Chance",summary:"Wie Apps und Software den Alltag erleichtern.",imageUrl:"https://images.unsplash.com/photo-1504384308090-c54be3855833?auto=format&fit=crop&q=80&w=1200",category:"Technologie",author:"Redaktion",publishedAt:"2025-10-20T10:00:00.000Z",featured:false,status:'published',views:410},
        {id:"art-5",type:"article",title:"Wärmepumpen-Förderung: Update Q4",summary:"Die neuesten Infos vom BAFA.",imageUrl:"https://images.unsplash.com/photo-1581094794329-cd2d2dec5d83?auto=format&fit=crop&q=80&w=1200",category:"Energie & Nachhaltigkeit",author:"Hans Müller",publishedAt:"2025-10-18T10:00:00.000Z",featured:false,status:'published',views:1500}
    ];
    directory = [
        {id:"dir-1",name:"Heizungstechnik Müller GmbH",category:"Heizung",address:"Hauptstraße 10",city:"Mannheim",zip:"68159",phone":"0621 123456",website:"https://heizung-mueller.de",description:"Spezialist für moderne Heizsysteme und Wärmepumpen."},
        {id:"dir-2",name:"Sanitär-Service Weber",category:"Sanitär",address:"Bergheimer Straße 58",city:"Heidelberg",zip:"69115",phone":"06221 654321",website:"https://sanitaer-weber.de",description:"Komplettbäder aus einer Hand."},
        {id:"dir-3",name:"Klima-Profis Rhein-Neckar",category:"Klima",address:"Industriestraße 35",city:"Ludwigshafen",zip:"67063",phone":"0621 987654",website:"https://klima-profis-rn.de",description:"Installation und Wartung von Klimaanlagen."},
        {id:"dir-4",name:"Elektro Schmitt",category:"Elektro",address:"Waldstraße 12",city:"Schwetzingen",zip:"68723",phone":"06202 55555",website:"https://elektro-schmitt-test.de",description:"Smart Home und PV-Anlagen."}
    ];
}

function seedUsers(){users=[{id:"u1",name:"Admin",role:"Administrator",avatar:"https://ui-avatars.com/api/?name=Admin"}]}

// --- RENDER ---
function render() {
    const root = document.getElementById('app-root');
    if (!appState.currentUser) { root.innerHTML = renderLogin(); return; }
    root.innerHTML = `<div class="flex h-screen overflow-hidden">${renderSidebar()}<div class="relative flex flex-col flex-1 overflow-y-auto overflow-x-hidden">${renderHeader()}<main class="p-6">${renderMain()}</main></div></div>${appState.modalOpen?renderModal():''}`;
    lucide.createIcons();
}

function renderLogin(){ return `<div class="min-h-screen bg-brand-dark flex items-center justify-center"><div class="bg-white p-8 rounded shadow-lg w-96"><h2 class="text-xl font-bold mb-4">CMS Login</h2><button onclick="login()" class="w-full bg-brand-copper text-white py-2 rounded">Login as Admin</button></div></div>`}
function login(){ appState.currentUser=users[0]; render(); }
function logout(){ appState.currentUser=null; render(); }

function renderSidebar(){ 
    const nav = (id,ic,l) => `<button onclick="appState.activeView='${id}';render()" class="flex items-center w-full px-6 py-3 text-sm ${appState.activeView===id?'bg-brand-copper text-white':'text-gray-400 hover:text-white'}"><i data-lucide="${ic}" class="w-4 h-4 mr-3"></i> ${l}</button>`;
    return `<aside class="w-64 bg-brand-dark border-r border-gray-800 flex-col flex"><div class="h-20 flex items-center justify-center border-b border-gray-800"><span class="text-white font-bold">SHK CMS</span></div><div class="flex-1 py-4">${nav('dashboard','layout-dashboard','Dashboard')}${nav('articles','file-text','Articles')}${nav('directory','building-2','Directory')}</div><div class="p-4 border-t border-gray-800"><button onclick="appState.activeView='settings';render()" class="text-gray-400 text-sm flex items-center"><i data-lucide="settings" class="w-4 h-4 mr-2"></i> Settings</button></div></aside>`;
}
function renderHeader(){ return `<header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6"><h2 class="text-xl font-bold capitalize">${appState.activeView}</h2><div class="flex items-center space-x-2"><span class="text-sm font-bold">${appState.currentUser.name}</span></div></header>`}

function renderMain(){
    if(appState.activeView==='dashboard') return renderDashboard();
    if(appState.activeView==='articles') return renderArticles();
    if(appState.activeView==='directory') return renderDirectory();
    if(appState.activeView==='settings') return renderSettings();
    if(appState.activeView==='editor') return renderEditor();
    return '';
}

function renderDashboard(){
    return `<div class="grid grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded shadow"><h3 class="text-gray-500 text-xs font-bold uppercase">Total Articles</h3><p class="text-3xl font-bold">${articles.length}</p></div>
        <div class="bg-white p-6 rounded shadow"><h3 class="text-gray-500 text-xs font-bold uppercase">Directory Entries</h3><p class="text-3xl font-bold">${directory.length}</p></div>
    </div>`;
}

function renderArticles(){
    return `<div class="flex justify-between mb-6"><h3 class="font-bold">Manage Articles</h3><div class="flex gap-2"><button onclick="sync('articles')" class="border border-gray-300 px-4 py-2 rounded text-xs font-bold uppercase hover:bg-gray-50 flex items-center"><i data-lucide="refresh-cw" class="w-3 h-3 mr-2 ${appState.syncStateArticles==='loading'?'animate-spin':''}"></i> Sync Articles</button><button onclick="editItem(null,'article')" class="bg-brand-copper text-white px-4 py-2 rounded text-xs font-bold uppercase">New Article</button></div></div>
    <div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr><th class="p-4">Title</th><th class="p-4">Category</th><th class="p-4 text-right">Action</th></tr></thead>
    <tbody>${articles.map(a=>`<tr class="border-b"><td class="p-4">${a.title}</td><td class="p-4 text-gray-500">${a.category}</td><td class="p-4 text-right"><button onclick="editItem('${a.id}','article')" class="text-blue-600 mr-2">Edit</button><button onclick="deleteItem('${a.id}','article')" class="text-red-600">Delete</button></td></tr>`).join('')}</tbody></table></div>`;
}

function renderDirectory(){
    return `<div class="flex justify-between mb-6"><h3 class="font-bold">Manage Directory</h3><div class="flex gap-2"><button onclick="sync('directory')" class="border border-gray-300 px-4 py-2 rounded text-xs font-bold uppercase hover:bg-gray-50 flex items-center"><i data-lucide="refresh-cw" class="w-3 h-3 mr-2 ${appState.syncStateDirectory==='loading'?'animate-spin':''}"></i> Sync Directory</button><button onclick="openModal('business')" class="bg-brand-copper text-white px-4 py-2 rounded text-xs font-bold uppercase">Add Business</button></div></div>
    <div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr><th class="p-4">Name</th><th class="p-4">Category</th><th class="p-4 text-right">Action</th></tr></thead>
    <tbody>${directory.map(d=>`<tr class="border-b"><td class="p-4">${d.name}</td><td class="p-4 text-gray-500">${d.category}</td><td class="p-4 text-right"><button onclick="editBiz('${d.id}')" class="text-blue-600 mr-2">Edit</button><button onclick="deleteItem('${d.id}','directory')" class="text-red-600">Delete</button></td></tr>`).join('')}</tbody></table></div>`;
}

function renderSettings(){
    return `<div class="bg-white p-8 rounded shadow max-w-2xl">
        <h3 class="font-bold text-lg mb-6">Backend Configuration</h3>
        <div class="space-y-6">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Articles Google Apps Script URL</label>
                <div class="flex gap-2"><input id="url-articles" value="${settings.articlesScriptUrl}" class="flex-1 border p-2 rounded text-sm"><button onclick="sync('articles')" class="bg-gray-100 border px-4 rounded text-xs font-bold">Sync</button></div>
                <p class="text-xs ${appState.syncStateArticles==='success'?'text-green-600':'text-gray-400'} mt-1">${appState.syncStateArticles==='success'?'Sync Successful':(appState.syncStateArticles==='error'?'Sync Failed':'IDLE')}</p>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Directory Google Apps Script URL</label>
                <div class="flex gap-2"><input id="url-directory" value="${settings.directoryScriptUrl}" class="flex-1 border p-2 rounded text-sm"><button onclick="sync('directory')" class="bg-gray-100 border px-4 rounded text-xs font-bold">Sync</button></div>
                <p class="text-xs ${appState.syncStateDirectory==='success'?'text-green-600':'text-gray-400'} mt-1">${appState.syncStateDirectory==='success'?'Sync Successful':(appState.syncStateDirectory==='error'?'Sync Failed':'IDLE')}</p>
            </div>
            <button onclick="saveSettingsUI()" class="bg-brand-dark text-white px-6 py-2 rounded font-bold text-xs uppercase mt-4">Save URLs</button>
        </div>
    </div>`;
}

function renderEditor(){
    const a = appState.editingItem;
    return `<div class="bg-white p-6 rounded shadow h-full flex flex-col">
        <input id="ed-title" value="${a.title}" placeholder="Title" class="text-2xl font-bold mb-4 border-none outline-none w-full">
        <div class="flex gap-2 mb-4 border-b pb-2"><button onclick="document.execCommand('bold')" class="p-1 font-bold">B</button><button onclick="document.execCommand('italic')" class="p-1 italic">I</button></div>
        <div id="ed-content" contenteditable="true" class="flex-1 outline-none prose max-w-none">${a.content||'<p>Start writing...</p>'}</div>
        <div class="mt-4 flex justify-between items-center border-t pt-4">
            <select id="ed-cat" class="border p-1 text-sm">${categories.map(c=>`<option ${a.category===c?'selected':''}>${c}</option>`).join('')}</select>
            <div class="flex gap-2"><button onclick="appState.activeView='articles';render()" class="text-gray-500 px-4 py-2">Cancel</button><button onclick="saveArticle()" class="bg-brand-copper text-white px-4 py-2 rounded font-bold">Save Article</button></div>
        </div>
    </div>`;
}

function renderModal() {
    const d = appState.editingItem || {};
    return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center"><div class="bg-white p-6 rounded shadow w-96">
        <h3 class="font-bold mb-4">${d.id?'Edit':'Add'} Business</h3>
        <input id="m-name" value="${d.name||''}" placeholder="Name" class="w-full border p-2 mb-2 rounded">
        <input id="m-city" value="${d.city||''}" placeholder="City" class="w-full border p-2 mb-2 rounded">
        <select id="m-cat" class="w-full border p-2 mb-4 rounded">${['Heizung','Sanitär','Klima'].map(c=>`<option ${d.category===c?'selected':''}>${c}</option>`).join('')}</select>
        <div class="flex justify-end gap-2"><button onclick="appState.modalOpen=false;render()" class="text-gray-500">Cancel</button><button onclick="saveBiz()" class="bg-brand-copper text-white px-4 py-2 rounded">Save</button></div>
    </div></div>`;
}

// --- LOGIC ---
function editItem(id, type) {
    if(type==='article') {
        appState.editingItem = id ? {...articles.find(a=>a.id===id)} : {id:'',title:'',content:'',category:'Branchen-News'};
        appState.activeView='editor';
    } else {
        // ...
    }
    render();
}
function editBiz(id) { appState.editingItem = id ? {...directory.find(d=>d.id===id)} : {}; appState.modalOpen=true; render(); }

function saveArticle() {
    const a = appState.editingItem;
    a.title = document.getElementById('ed-title').value;
    a.content = document.getElementById('ed-content').innerHTML;
    a.category = document.getElementById('ed-cat').value;
    a.summary = a.content.replace(/<[^>]*>/g, '').substring(0,100)+'...';
    if(!a.id) a.id = 'art-'+Date.now();
    a.publishedAt = a.publishedAt || new Date().toISOString();
    
    const idx = articles.findIndex(x=>x.id===a.id);
    if(idx>=0) articles[idx]=a; else articles.unshift(a);
    saveData();
    appState.activeView='articles';
    render();
}

function saveBiz() {
    const b = appState.editingItem;
    b.name = document.getElementById('m-name').value;
    b.city = document.getElementById('m-city').value;
    b.category = document.getElementById('m-cat').value;
    if(!b.id) b.id = 'dir-'+Date.now();
    const idx = directory.findIndex(x=>x.id===b.id);
    if(idx>=0) directory[idx]=b; else directory.unshift(b);
    saveData();
    appState.modalOpen=false;
    render();
}

function deleteItem(id, type) {
    if(!confirm('Delete?')) return;
    if(type==='article') articles = articles.filter(a=>a.id!==id);
    if(type==='directory') directory = directory.filter(d=>d.id!==id);
    saveData();
    render();
}

function saveSettingsUI() {
    settings.articlesScriptUrl = document.getElementById('url-articles').value;
    settings.directoryScriptUrl = document.getElementById('url-directory').value;
    saveData();
    alert('Settings Saved');
}

async function sync(type) {
    const isArt = type==='articles';
    const url = isArt ? settings.articlesScriptUrl : settings.directoryScriptUrl;
    if(!url) return alert('No URL configured in settings');
    
    if(isArt) appState.syncStateArticles='loading'; else appState.syncStateDirectory='loading';
    render();

    const payload = {
        action: 'sync',
        articles: isArt ? articles : undefined,
        directory: !isArt ? directory : undefined,
        categories: categories
    };

    try {
        await fetch(url, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'text/plain'}, body: JSON.stringify(payload) });
        // Optimistic success
        setTimeout(() => {
            if(isArt) appState.syncStateArticles='success'; else appState.syncStateDirectory='success';
            render();
            setTimeout(() => {
                if(isArt) appState.syncStateArticles='idle'; else appState.syncStateDirectory='idle';
                render();
            }, 3000);
        }, 1500);
    } catch(e) {
        console.error(e);
        if(isArt) appState.syncStateArticles='error'; else appState.syncStateDirectory='error';
        render();
    }
}

document.addEventListener('DOMContentLoaded', ()=> { loadData(); render(); });
</script>
</body>
</html>